<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>1789-as-cell - The Rust RFC Book</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body class="light">
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { } 
            if (theme === null || theme === undefined) { theme = default_theme; }
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <ol class="chapter"><li class="affix"><a href="introduction.html">Introduction</a></li><li><a href="0001-private-fields.html">0001-private-fields</a></li><li><a href="0002-rfc-process.html">0002-rfc-process</a></li><li><a href="0003-attribute-usage.html">0003-attribute-usage</a></li><li><a href="0008-new-intrinsics.html">0008-new-intrinsics</a></li><li><a href="0016-more-attributes.html">0016-more-attributes</a></li><li><a href="0019-opt-in-builtin-traits.html">0019-opt-in-builtin-traits</a></li><li><a href="0026-remove-priv.html">0026-remove-priv</a></li><li><a href="0034-bounded-type-parameters.html">0034-bounded-type-parameters</a></li><li><a href="0040-libstd-facade.html">0040-libstd-facade</a></li><li><a href="0042-regexps.html">0042-regexps</a></li><li><a href="0048-traits.html">0048-traits</a></li><li><a href="0049-match-arm-attributes.html">0049-match-arm-attributes</a></li><li><a href="0050-assert.html">0050-assert</a></li><li><a href="0059-remove-tilde.html">0059-remove-tilde</a></li><li><a href="0060-rename-strbuf.html">0060-rename-strbuf</a></li><li><a href="0063-module-file-system-hierarchy.html">0063-module-file-system-hierarchy</a></li><li><a href="0066-better-temporary-lifetimes.html">0066-better-temporary-lifetimes</a></li><li><a href="0068-const-unsafe-pointers.html">0068-const-unsafe-pointers</a></li><li><a href="0069-ascii-literals.html">0069-ascii-literals</a></li><li><a href="0071-const-block-expr.html">0071-const-block-expr</a></li><li><a href="0079-undefined-struct-layout.html">0079-undefined-struct-layout</a></li><li><a href="0085-pattern-macros.html">0085-pattern-macros</a></li><li><a href="0086-plugin-registrar.html">0086-plugin-registrar</a></li><li><a href="0087-trait-bounds-with-plus.html">0087-trait-bounds-with-plus</a></li><li><a href="0089-loadable-lints.html">0089-loadable-lints</a></li><li><a href="0090-lexical-syntax-simplification.html">0090-lexical-syntax-simplification</a></li><li><a href="0092-struct-grammar.html">0092-struct-grammar</a></li><li><a href="0093-remove-format-intl.html">0093-remove-format-intl</a></li><li><a href="0100-partial-cmp.html">0100-partial-cmp</a></li><li><a href="0107-pattern-guards-with-bind-by-move.html">0107-pattern-guards-with-bind-by-move</a></li><li><a href="0109-remove-crate-id.html">0109-remove-crate-id</a></li><li><a href="0111-index-traits.html">0111-index-traits</a></li><li><a href="0112-remove-cross-borrowing.html">0112-remove-cross-borrowing</a></li><li><a href="0114-closures.html">0114-closures</a></li><li><a href="0115-rm-integer-fallback.html">0115-rm-integer-fallback</a></li><li><a href="0116-no-module-shadowing.html">0116-no-module-shadowing</a></li><li><a href="0123-share-to-threadsafe.html">0123-share-to-threadsafe</a></li><li><a href="0130-box-not-special.html">0130-box-not-special</a></li><li><a href="0131-target-specification.html">0131-target-specification</a></li><li><a href="0132-ufcs.html">0132-ufcs</a></li><li><a href="0135-where.html">0135-where</a></li><li><a href="0136-no-privates-in-public.html">0136-no-privates-in-public</a></li><li><a href="0139-remove-cross-borrowing-entirely.html">0139-remove-cross-borrowing-entirely</a></li><li><a href="0141-lifetime-elision.html">0141-lifetime-elision</a></li><li><a href="0151-capture-by-value.html">0151-capture-by-value</a></li><li><a href="0155-anonymous-impl-only-in-same-module.html">0155-anonymous-impl-only-in-same-module</a></li><li><a href="0160-if-let.html">0160-if-let</a></li><li><a href="0164-feature-gate-slice-pats.html">0164-feature-gate-slice-pats</a></li><li><a href="0168-mod.html">0168-mod</a></li><li><a href="0169-use-path-as-id.html">0169-use-path-as-id</a></li><li><a href="0179-and-mut-patterns.html">0179-and-mut-patterns</a></li><li><a href="0184-tuple-accessors.html">0184-tuple-accessors</a></li><li><a href="0192-bounds-on-object-and-generic-types.html">0192-bounds-on-object-and-generic-types</a></li><li><a href="0194-cfg-syntax.html">0194-cfg-syntax</a></li><li><a href="0195-associated-items.html">0195-associated-items</a></li><li><a href="0198-slice-notation.html">0198-slice-notation</a></li><li><a href="0199-ownership-variants.html">0199-ownership-variants</a></li><li><a href="0201-error-chaining.html">0201-error-chaining</a></li><li><a href="0202-subslice-syntax-change.html">0202-subslice-syntax-change</a></li><li><a href="0212-restore-int-fallback.html">0212-restore-int-fallback</a></li><li><a href="0213-defaulted-type-params.html">0213-defaulted-type-params</a></li><li><a href="0214-while-let.html">0214-while-let</a></li><li><a href="0216-collection-views.html">0216-collection-views</a></li><li><a href="0218-empty-struct-with-braces.html">0218-empty-struct-with-braces</a></li><li><a href="0221-panic.html">0221-panic</a></li><li><a href="0230-remove-runtime.html">0230-remove-runtime</a></li><li><a href="0231-upvar-capture-inference.html">0231-upvar-capture-inference</a></li><li><a href="0234-variants-namespace.html">0234-variants-namespace</a></li><li><a href="0235-collections-conventions.html">0235-collections-conventions</a></li><li><a href="0236-error-conventions.html">0236-error-conventions</a></li><li><a href="0240-unsafe-api-location.html">0240-unsafe-api-location</a></li><li><a href="0241-deref-conversions.html">0241-deref-conversions</a></li><li><a href="0243-trait-based-exception-handling.html">0243-trait-based-exception-handling</a></li><li><a href="0246-const-vs-static.html">0246-const-vs-static</a></li><li><a href="0255-object-safety.html">0255-object-safety</a></li><li><a href="0256-remove-refcounting-gc-of-t.html">0256-remove-refcounting-gc-of-t</a></li><li><a href="0320-nonzeroing-dynamic-drop.html">0320-nonzeroing-dynamic-drop</a></li><li><a href="0326-restrict-xXX-to-ascii.html">0326-restrict-xXX-to-ascii</a></li><li><a href="0339-statically-sized-literals.html">0339-statically-sized-literals</a></li><li><a href="0341-remove-virtual-structs.html">0341-remove-virtual-structs</a></li><li><a href="0342-keywords.html">0342-keywords</a></li><li><a href="0344-conventions-galore.html">0344-conventions-galore</a></li><li><a href="0356-no-module-prefixes.html">0356-no-module-prefixes</a></li><li><a href="0369-num-reform.html">0369-num-reform</a></li><li><a href="0378-expr-macros.html">0378-expr-macros</a></li><li><a href="0379-remove-reflection.html">0379-remove-reflection</a></li><li><a href="0380-stabilize-std-fmt.html">0380-stabilize-std-fmt</a></li><li><a href="0385-module-system-cleanup.html">0385-module-system-cleanup</a></li><li><a href="0387-higher-ranked-trait-bounds.html">0387-higher-ranked-trait-bounds</a></li><li><a href="0390-enum-namespacing.html">0390-enum-namespacing</a></li><li><a href="0401-coercions.html">0401-coercions</a></li><li><a href="0403-cargo-build-command.html">0403-cargo-build-command</a></li><li><a href="0404-change-prefer-dynamic.html">0404-change-prefer-dynamic</a></li><li><a href="0418-struct-variants.html">0418-struct-variants</a></li><li><a href="0430-finalizing-naming-conventions.html">0430-finalizing-naming-conventions</a></li><li><a href="0438-precedence-of-plus.html">0438-precedence-of-plus</a></li><li><a href="0439-cmp-ops-reform.html">0439-cmp-ops-reform</a></li><li><a href="0445-extension-trait-conventions.html">0445-extension-trait-conventions</a></li><li><a href="0446-es6-unicode-escapes.html">0446-es6-unicode-escapes</a></li><li><a href="0447-no-unused-impl-parameters.html">0447-no-unused-impl-parameters</a></li><li><a href="0450-un-feature-gate-some-more-gates.html">0450-un-feature-gate-some-more-gates</a></li><li><a href="0453-macro-reform.html">0453-macro-reform</a></li><li><a href="0458-send-improvements.html">0458-send-improvements</a></li><li><a href="0459-disallow-shadowing.html">0459-disallow-shadowing</a></li><li><a href="0461-tls-overhaul.html">0461-tls-overhaul</a></li><li><a href="0463-future-proof-literal-suffixes.html">0463-future-proof-literal-suffixes</a></li><li><a href="0469-feature-gate-box-patterns.html">0469-feature-gate-box-patterns</a></li><li><a href="0474-path-reform.html">0474-path-reform</a></li><li><a href="0486-std-ascii-reform.html">0486-std-ascii-reform</a></li><li><a href="0490-dst-syntax.html">0490-dst-syntax</a></li><li><a href="0494-c_str-and-c_vec-stability.html">0494-c_str-and-c_vec-stability</a></li><li><a href="0495-array-pattern-changes.html">0495-array-pattern-changes</a></li><li><a href="0501-consistent_no_prelude_attributes.html">0501-consistent_no_prelude_attributes</a></li><li><a href="0503-prelude-stabilization.html">0503-prelude-stabilization</a></li><li><a href="0504-show-stabilization.html">0504-show-stabilization</a></li><li><a href="0505-api-comment-conventions.html">0505-api-comment-conventions</a></li><li><a href="0507-release-channels.html">0507-release-channels</a></li><li><a href="0509-collections-reform-part-2.html">0509-collections-reform-part-2</a></li><li><a href="0517-io-os-reform.html">0517-io-os-reform</a></li><li><a href="0520-new-array-repeat-syntax.html">0520-new-array-repeat-syntax</a></li><li><a href="0522-self-impl.html">0522-self-impl</a></li><li><a href="0526-fmt-text-writer.html">0526-fmt-text-writer</a></li><li><a href="0528-string-patterns.html">0528-string-patterns</a></li><li><a href="0529-conversion-traits.html">0529-conversion-traits</a></li><li><a href="0531-define-rfc-scope.html">0531-define-rfc-scope</a></li><li><a href="0532-self-in-use.html">0532-self-in-use</a></li><li><a href="0533-no-array-elem-moves.html">0533-no-array-elem-moves</a></li><li><a href="0534-deriving2derive.html">0534-deriving2derive</a></li><li><a href="0544-rename-int-uint.html">0544-rename-int-uint</a></li><li><a href="0546-Self-not-sized-by-default.html">0546-Self-not-sized-by-default</a></li><li><a href="0550-macro-future-proofing.html">0550-macro-future-proofing</a></li><li><a href="0556-raw-lifetime.html">0556-raw-lifetime</a></li><li><a href="0558-require-parentheses-for-chained-comparisons.html">0558-require-parentheses-for-chained-comparisons</a></li><li><a href="0560-integer-overflow.html">0560-integer-overflow</a></li><li><a href="0563-remove-ndebug.html">0563-remove-ndebug</a></li><li><a href="0565-show-string-guidelines.html">0565-show-string-guidelines</a></li><li><a href="0572-rustc-attribute.html">0572-rustc-attribute</a></li><li><a href="0574-drain-range.html">0574-drain-range</a></li><li><a href="0580-rename-collections.html">0580-rename-collections</a></li><li><a href="0587-fn-return-should-be-an-associated-type.html">0587-fn-return-should-be-an-associated-type</a></li><li><a href="0592-c-str-deref.html">0592-c-str-deref</a></li><li><a href="0593-forbid-Self-definitions.html">0593-forbid-Self-definitions</a></li><li><a href="0599-default-object-bound.html">0599-default-object-bound</a></li><li><a href="0601-replace-be-with-become.html">0601-replace-be-with-become</a></li><li><a href="0639-discriminant-intrinsic.html">0639-discriminant-intrinsic</a></li><li><a href="0640-debug-improvements.html">0640-debug-improvements</a></li><li><a href="0702-rangefull-expression.html">0702-rangefull-expression</a></li><li><a href="0735-allow-inherent-impls-anywhere.html">0735-allow-inherent-impls-anywhere</a></li><li><a href="0736-privacy-respecting-fru.html">0736-privacy-respecting-fru</a></li><li><a href="0738-variance.html">0738-variance</a></li><li><a href="0769-sound-generic-drop.html">0769-sound-generic-drop</a></li><li><a href="0771-std-iter-once.html">0771-std-iter-once</a></li><li><a href="0803-type-ascription.html">0803-type-ascription</a></li><li><a href="0809-box-and-in-for-stdlib.html">0809-box-and-in-for-stdlib</a></li><li><a href="0823-hash-simplification.html">0823-hash-simplification</a></li><li><a href="0832-from-elem-with-love.html">0832-from-elem-with-love</a></li><li><a href="0839-embrace-extend-extinguish.html">0839-embrace-extend-extinguish</a></li><li><a href="0840-no-panic-in-c-string.html">0840-no-panic-in-c-string</a></li><li><a href="0873-type-macros.html">0873-type-macros</a></li><li><a href="0879-small-base-lexing.html">0879-small-base-lexing</a></li><li><a href="0888-compiler-fence-intrinsics.html">0888-compiler-fence-intrinsics</a></li><li><a href="0909-move-thread-local-to-std-thread.html">0909-move-thread-local-to-std-thread</a></li><li><a href="0911-const-fn.html">0911-const-fn</a></li><li><a href="0921-entry_v3.html">0921-entry_v3</a></li><li><a href="0940-hyphens-considered-harmful.html">0940-hyphens-considered-harmful</a></li><li><a href="0953-op-assign.html">0953-op-assign</a></li><li><a href="0968-closure-return-type-syntax.html">0968-closure-return-type-syntax</a></li><li><a href="0979-align-splitn-with-other-languages.html">0979-align-splitn-with-other-languages</a></li><li><a href="0980-read-exact.html">0980-read-exact</a></li><li><a href="0982-dst-coercion.html">0982-dst-coercion</a></li><li><a href="1011-process.exit.html">1011-process.exit</a></li><li><a href="1014-stdout-existential-crisis.html">1014-stdout-existential-crisis</a></li><li><a href="1023-rebalancing-coherence.html">1023-rebalancing-coherence</a></li><li><a href="1030-prelude-additions.html">1030-prelude-additions</a></li><li><a href="1040-duration-reform.html">1040-duration-reform</a></li><li><a href="1044-io-fs-2.1.html">1044-io-fs-2.1</a></li><li><a href="1047-socket-timeouts.html">1047-socket-timeouts</a></li><li><a href="1048-rename-soft-link-to-symlink.html">1048-rename-soft-link-to-symlink</a></li><li><a href="1054-str-words.html">1054-str-words</a></li><li><a href="1057-io-error-sync.html">1057-io-error-sync</a></li><li><a href="1058-slice-tail-redesign.html">1058-slice-tail-redesign</a></li><li><a href="1066-safe-mem-forget.html">1066-safe-mem-forget</a></li><li><a href="1068-rust-governance.html">1068-rust-governance</a></li><li><a href="1096-remove-static-assert.html">1096-remove-static-assert</a></li><li><a href="1102-rename-connect-to-join.html">1102-rename-connect-to-join</a></li><li><a href="1105-api-evolution.html">1105-api-evolution</a></li><li><a href="1119-result-expect.html">1119-result-expect</a></li><li><a href="1122-language-semver.html">1122-language-semver</a></li><li><a href="1123-str-split-at.html">1123-str-split-at</a></li><li><a href="1131-likely-intrinsic.html">1131-likely-intrinsic</a></li><li><a href="1135-raw-pointer-comparisons.html">1135-raw-pointer-comparisons</a></li><li><a href="1152-slice-string-symmetry.html">1152-slice-string-symmetry</a></li><li><a href="1156-adjust-default-object-bounds.html">1156-adjust-default-object-bounds</a></li><li><a href="1174-into-raw-fd-socket-handle-traits.html">1174-into-raw-fd-socket-handle-traits</a></li><li><a href="1183-swap-out-jemalloc.html">1183-swap-out-jemalloc</a></li><li><a href="1184-stabilize-no_std.html">1184-stabilize-no_std</a></li><li><a href="1191-hir.html">1191-hir</a></li><li><a href="1192-inclusive-ranges.html">1192-inclusive-ranges</a></li><li><a href="1193-cap-lints.html">1193-cap-lints</a></li><li><a href="1194-set-recovery.html">1194-set-recovery</a></li><li><a href="1199-simd-infrastructure.html">1199-simd-infrastructure</a></li><li><a href="1200-cargo-install.html">1200-cargo-install</a></li><li><a href="1201-naked-fns.html">1201-naked-fns</a></li><li><a href="1210-impl-specialization.html">1210-impl-specialization</a></li><li><a href="1211-mir.html">1211-mir</a></li><li><a href="1212-line-endings.html">1212-line-endings</a></li><li><a href="1214-projections-lifetimes-and-wf.html">1214-projections-lifetimes-and-wf</a></li><li><a href="1216-bang-type.html">1216-bang-type</a></li><li><a href="1219-use-group-as.html">1219-use-group-as</a></li><li><a href="1228-placement-left-arrow.html">1228-placement-left-arrow</a></li><li><a href="1229-compile-time-asserts.html">1229-compile-time-asserts</a></li><li><a href="1236-stabilize-catch-panic.html">1236-stabilize-catch-panic</a></li><li><a href="1238-nonparametric-dropck.html">1238-nonparametric-dropck</a></li><li><a href="1240-repr-packed-unsafe-ref.html">1240-repr-packed-unsafe-ref</a></li><li><a href="1241-no-wildcard-deps.html">1241-no-wildcard-deps</a></li><li><a href="1242-rust-lang-crates.html">1242-rust-lang-crates</a></li><li><a href="1252-open-options.html">1252-open-options</a></li><li><a href="1257-drain-range-2.html">1257-drain-range-2</a></li><li><a href="1260-main-reexport.html">1260-main-reexport</a></li><li><a href="1268-allow-overlapping-impls-on-marker-traits.html">1268-allow-overlapping-impls-on-marker-traits</a></li><li><a href="1270-deprecation.html">1270-deprecation</a></li><li><a href="1288-time-improvements.html">1288-time-improvements</a></li><li><a href="1291-promote-libc.html">1291-promote-libc</a></li><li><a href="1298-incremental-compilation.html">1298-incremental-compilation</a></li><li><a href="1300-intrinsic-semantics.html">1300-intrinsic-semantics</a></li><li><a href="1307-osstring-methods.html">1307-osstring-methods</a></li><li><a href="1317-ide.html">1317-ide</a></li><li><a href="1327-dropck-param-eyepatch.html">1327-dropck-param-eyepatch</a></li><li><a href="1328-global-panic-handler.html">1328-global-panic-handler</a></li><li><a href="1331-grammar-is-canonical.html">1331-grammar-is-canonical</a></li><li><a href="1358-repr-align.html">1358-repr-align</a></li><li><a href="1359-process-ext-unix.html">1359-process-ext-unix</a></li><li><a href="1361-cargo-cfg-dependencies.html">1361-cargo-cfg-dependencies</a></li><li><a href="1398-kinds-of-allocators.html">1398-kinds-of-allocators</a></li><li><a href="1399-repr-pack.html">1399-repr-pack</a></li><li><a href="1414-rvalue_static_promotion.html">1414-rvalue_static_promotion</a></li><li><a href="1415-trim-std-os.html">1415-trim-std-os</a></li><li><a href="1419-slice-copy.html">1419-slice-copy</a></li><li><a href="1422-pub-restricted.html">1422-pub-restricted</a></li><li><a href="1432-replace-slice.html">1432-replace-slice</a></li><li><a href="1434-contains-method-for-ranges.html">1434-contains-method-for-ranges</a></li><li><a href="1440-drop-types-in-const.html">1440-drop-types-in-const</a></li><li><a href="1443-extended-compare-and-swap.html">1443-extended-compare-and-swap</a></li><li><a href="1444-union.html">1444-union</a></li><li><a href="1445-restrict-constants-in-patterns.html">1445-restrict-constants-in-patterns</a></li><li><a href="1461-net2-mutators.html">1461-net2-mutators</a></li><li><a href="1467-volatile.html">1467-volatile</a></li><li><a href="1479-unix-socket.html">1479-unix-socket</a></li><li><a href="1492-dotdot-in-patterns.html">1492-dotdot-in-patterns</a></li><li><a href="1498-ipv6addr-octets.html">1498-ipv6addr-octets</a></li><li><a href="1504-int128.html">1504-int128</a></li><li><a href="1506-adt-kinds.html">1506-adt-kinds</a></li><li><a href="1510-cdylib.html">1510-cdylib</a></li><li><a href="1513-less-unwinding.html">1513-less-unwinding</a></li><li><a href="1521-copy-clone-semantics.html">1521-copy-clone-semantics</a></li><li><a href="1522-conservative-impl-trait.html">1522-conservative-impl-trait</a></li><li><a href="1525-cargo-workspace.html">1525-cargo-workspace</a></li><li><a href="1535-stable-overflow-checks.html">1535-stable-overflow-checks</a></li><li><a href="1542-try-from.html">1542-try-from</a></li><li><a href="1543-integer_atomics.html">1543-integer_atomics</a></li><li><a href="1548-global-asm.html">1548-global-asm</a></li><li><a href="1552-contains-method-for-various-collections.html">1552-contains-method-for-various-collections</a></li><li><a href="1558-closure-to-fn-coercion.html">1558-closure-to-fn-coercion</a></li><li><a href="1559-attributes-with-literals.html">1559-attributes-with-literals</a></li><li><a href="1560-name-resolution.html">1560-name-resolution</a></li><li><a href="1561-macro-naming.html">1561-macro-naming</a></li><li><a href="1566-proc-macros.html">1566-proc-macros</a></li><li><a href="1567-long-error-codes-explanation-normalization.html">1567-long-error-codes-explanation-normalization</a></li><li><a href="1574-more-api-documentation-conventions.html">1574-more-api-documentation-conventions</a></li><li><a href="1576-macros-literal-matcher.html">1576-macros-literal-matcher</a></li><li><a href="1581-fused-iterator.html">1581-fused-iterator</a></li><li><a href="1584-macros.html">1584-macros</a></li><li><a href="1589-rustc-bug-fix-procedure.html">1589-rustc-bug-fix-procedure</a></li><li><a href="1590-macro-lifetimes.html">1590-macro-lifetimes</a></li><li><a href="1598-generic_associated_types.html">1598-generic_associated_types</a></li><li><a href="1607-style-rfcs.html">1607-style-rfcs</a></li><li><a href="1618-ergonomic-format-args.html">1618-ergonomic-format-args</a></li><li><a href="1620-regex-1.0.html">1620-regex-1.0</a></li><li><a href="1623-static.html">1623-static</a></li><li><a href="1624-loop-break-value.html">1624-loop-break-value</a></li><li><a href="1636-document_all_features.html">1636-document_all_features</a></li><li><a href="1640-duration-checked-sub.html">1640-duration-checked-sub</a></li><li><a href="1643-memory-model-strike-team.html">1643-memory-model-strike-team</a></li><li><a href="1644-default-and-expanded-rustc-errors.html">1644-default-and-expanded-rustc-errors</a></li><li><a href="1647-allow-self-in-where-clauses.html">1647-allow-self-in-where-clauses</a></li><li><a href="1649-atomic-access.html">1649-atomic-access</a></li><li><a href="1651-movecell.html">1651-movecell</a></li><li><a href="1653-assert_ne.html">1653-assert_ne</a></li><li><a href="1660-try-borrow.html">1660-try-borrow</a></li><li><a href="1665-windows-subsystem.html">1665-windows-subsystem</a></li><li><a href="1679-panic-safe-slicing.html">1679-panic-safe-slicing</a></li><li><a href="1681-macros-1.1.html">1681-macros-1.1</a></li><li><a href="1682-field-init-shorthand.html">1682-field-init-shorthand</a></li><li><a href="1683-docs-team.html">1683-docs-team</a></li><li><a href="1685-deprecate-anonymous-parameters.html">1685-deprecate-anonymous-parameters</a></li><li><a href="1695-add-error-macro.html">1695-add-error-macro</a></li><li><a href="1696-discriminant.html">1696-discriminant</a></li><li><a href="1717-dllimport.html">1717-dllimport</a></li><li><a href="1721-crt-static.html">1721-crt-static</a></li><li><a href="1725-unaligned-access.html">1725-unaligned-access</a></li><li><a href="1728-north-star.html">1728-north-star</a></li><li><a href="1733-trait-alias.html">1733-trait-alias</a></li><li><a href="1758-repr-transparent.html">1758-repr-transparent</a></li><li><a href="1774-roadmap-2017.html">1774-roadmap-2017</a></li><li><a href="1789-as-cell.html" class="active">1789-as-cell</a></li><li><a href="1824-crates.io-default-ranking.html">1824-crates.io-default-ranking</a></li><li><a href="1826-change-doc-default-urls.html">1826-change-doc-default-urls</a></li><li><a href="1828-rust-bookshelf.html">1828-rust-bookshelf</a></li><li><a href="1845-shared-from-slice.html">1845-shared-from-slice</a></li><li><a href="1849-non-static-type-id.html">1849-non-static-type-id</a></li><li><a href="1857-stabilize-drop-order.html">1857-stabilize-drop-order</a></li><li><a href="1859-try-trait.html">1859-try-trait</a></li><li><a href="1860-manually-drop.html">1860-manually-drop</a></li><li><a href="1861-extern-types.html">1861-extern-types</a></li><li><a href="1866-more-readable-assert-eq.html">1866-more-readable-assert-eq</a></li><li><a href="1868-portability-lint.html">1868-portability-lint</a></li><li><a href="1869-eprintln.html">1869-eprintln</a></li><li><a href="1884-unstable-sort.html">1884-unstable-sort</a></li><li><a href="1892-uninitialized-uninhabited.html">1892-uninitialized-uninhabited</a></li><li><a href="1909-unsized-rvalues.html">1909-unsized-rvalues</a></li><li><a href="1925-optional-match-vert.html">1925-optional-match-vert</a></li><li><a href="1937-ques-in-main.html">1937-ques-in-main</a></li><li><a href="1940-must-use-functions.html">1940-must-use-functions</a></li><li><a href="1946-intra-rustdoc-links.html">1946-intra-rustdoc-links</a></li><li><a href="1951-expand-impl-trait.html">1951-expand-impl-trait</a></li><li><a href="1961-clamp.html">1961-clamp</a></li><li><a href="1966-unsafe-pointer-reform.html">1966-unsafe-pointer-reform</a></li><li><a href="1969-cargo-prepublish.html">1969-cargo-prepublish</a></li><li><a href="1974-global-allocators.html">1974-global-allocators</a></li><li><a href="1977-public-private-dependencies.html">1977-public-private-dependencies</a></li><li><a href="1983-nursery-deprecation.html">1983-nursery-deprecation</a></li><li><a href="1985-tiered-browser-support.html">1985-tiered-browser-support</a></li><li><a href="1990-external-doc-attribute.html">1990-external-doc-attribute</a></li><li><a href="2000-const-generics.html">2000-const-generics</a></li><li><a href="2005-match-ergonomics.html">2005-match-ergonomics</a></li><li><a href="2008-non-exhaustive.html">2008-non-exhaustive</a></li><li><a href="2011-generic-assert.html">2011-generic-assert</a></li><li><a href="2025-nested-method-calls.html">2025-nested-method-calls</a></li><li><a href="2027-object_safe_for_dispatch.html">2027-object_safe_for_dispatch</a></li><li><a href="2033-experimental-coroutines.html">2033-experimental-coroutines</a></li><li><a href="2043-is-aligned-intrinsic.html">2043-is-aligned-intrinsic</a></li><li><a href="2044-license-rfcs.html">2044-license-rfcs</a></li><li><a href="2045-target-feature.html">2045-target-feature</a></li><li><a href="2046-label-break-value.html">2046-label-break-value</a></li><li><a href="2052-epochs.html">2052-epochs</a></li><li><a href="2056-allow-trivial-where-clause-constraints.html">2056-allow-trivial-where-clause-constraints</a></li><li><a href="2057-refcell-replace.html">2057-refcell-replace</a></li><li><a href="2070-panic-implementation.html">2070-panic-implementation</a></li><li><a href="2071-impl-trait-existential-types.html">2071-impl-trait-existential-types</a></li><li><a href="2071-impl-trait-type-alias.html">2071-impl-trait-type-alias</a></li><li><a href="2086-allow-if-let-irrefutables.html">2086-allow-if-let-irrefutables</a></li><li><a href="2089-implied-bounds.html">2089-implied-bounds</a></li><li><a href="2091-inline-semantic.html">2091-inline-semantic</a></li><li><a href="2093-infer-outlives.html">2093-infer-outlives</a></li><li><a href="2094-nll.html">2094-nll</a></li><li><a href="2102-unnamed-fields.html">2102-unnamed-fields</a></li><li><a href="2103-tool-attributes.html">2103-tool-attributes</a></li><li><a href="2113-dyn-trait-syntax.html">2113-dyn-trait-syntax</a></li><li><a href="2115-argument-lifetimes.html">2115-argument-lifetimes</a></li><li><a href="2116-alloc-me-maybe.html">2116-alloc-me-maybe</a></li><li><a href="2124-option-filter.html">2124-option-filter</a></li><li><a href="2126-path-clarity.html">2126-path-clarity</a></li><li><a href="2128-use-nested-groups.html">2128-use-nested-groups</a></li><li><a href="2132-copy-closures.html">2132-copy-closures</a></li><li><a href="2133-all-the-clones.html">2133-all-the-clones</a></li><li><a href="2136-build-systems.html">2136-build-systems</a></li><li><a href="2137-variadic.html">2137-variadic</a></li><li><a href="2141-alternative-registries.html">2141-alternative-registries</a></li><li><a href="2145-type-privacy.html">2145-type-privacy</a></li><li><a href="2151-raw-identifiers.html">2151-raw-identifiers</a></li><li><a href="2166-impl-only-use.html">2166-impl-only-use</a></li><li><a href="2169-euclidean-modulo.html">2169-euclidean-modulo</a></li><li><a href="2175-if-while-or-patterns.html">2175-if-while-or-patterns</a></li><li><a href="2195-really-tagged-unions.html">2195-really-tagged-unions</a></li><li><a href="2196-metabuild.html">2196-metabuild</a></li><li><a href="2203-const-repeat-expr.html">2203-const-repeat-expr</a></li><li><a href="2226-fmt-debug-hex.html">2226-fmt-debug-hex</a></li><li><a href="2229-capture-disjoint-fields.html">2229-capture-disjoint-fields</a></li><li><a href="2230-bury-description.html">2230-bury-description</a></li><li><a href="2235-libc-struct-traits.html">2235-libc-struct-traits</a></li><li><a href="2250-finalize-impl-dyn-syntax.html">2250-finalize-impl-dyn-syntax</a></li><li><a href="2282-profile-dependencies.html">2282-profile-dependencies</a></li><li><a href="2289-associated-type-bounds.html">2289-associated-type-bounds</a></li><li><a href="2294-if-let-guard.html">2294-if-let-guard</a></li><li><a href="2295-os-str-pattern.html">2295-os-str-pattern</a></li><li><a href="2296-option-replace.html">2296-option-replace</a></li><li><a href="2298-macro-at-most-once-rep.html">2298-macro-at-most-once-rep</a></li><li><a href="2300-self-in-typedefs.html">2300-self-in-typedefs</a></li><li><a href="2302-tuple-struct-self-ctor.html">2302-tuple-struct-self-ctor</a></li><li><a href="2306-convert-id.html">2306-convert-id</a></li><li><a href="2307-concrete-nonzero-types.html">2307-concrete-nonzero-types</a></li><li><a href="2314-roadmap-2018.html">2314-roadmap-2018</a></li><li><a href="2318-custom-test-frameworks.html">2318-custom-test-frameworks</a></li><li><a href="2325-stable-simd.html">2325-stable-simd</a></li><li><a href="2333-prior-art.html">2333-prior-art</a></li><li><a href="2338-type-alias-enum-variants.html">2338-type-alias-enum-variants</a></li><li><a href="2341-const-locals.html">2341-const-locals</a></li><li><a href="2342-const-control-flow.html">2342-const-control-flow</a></li><li><a href="2344-const-looping.html">2344-const-looping</a></li><li><a href="2345-const-panic.html">2345-const-panic</a></li><li><a href="2349-pin.html">2349-pin</a></li><li><a href="2351-is-sorted.html">2351-is-sorted</a></li><li><a href="2359-subslice-pattern-syntax.html">2359-subslice-pattern-syntax</a></li><li><a href="2360-bench-black-box.html">2360-bench-black-box</a></li><li><a href="2361-dbg-macro.html">2361-dbg-macro</a></li><li><a href="2363-arbitrary-enum-discriminant.html">2363-arbitrary-enum-discriminant</a></li><li><a href="2383-lint-reasons.html">2383-lint-reasons</a></li><li><a href="2386-used.html">2386-used</a></li><li><a href="2388-try-expr.html">2388-try-expr</a></li><li><a href="2394-async_await.html">2394-async_await</a></li><li><a href="2397-do-not-recommend.html">2397-do-not-recommend</a></li><li><a href="2412-optimize-attr.html">2412-optimize-attr</a></li><li><a href="2420-unreserve-proc.html">2420-unreserve-proc</a></li><li><a href="2421-unreservations-2018.html">2421-unreservations-2018</a></li><li><a href="2436-style-guide.html">2436-style-guide</a></li><li><a href="2437-rustfmt-stability.html">2437-rustfmt-stability</a></li><li><a href="2438-deny-integer-literal-overflow-lint.html">2438-deny-integer-literal-overflow-lint</a></li><li><a href="2451-re-rebalancing-coherence.html">2451-re-rebalancing-coherence</a></li><li><a href="2457-non-ascii-idents.html">2457-non-ascii-idents</a></li><li><a href="2471-lint-test-inner-function.html">2471-lint-test-inner-function</a></li><li><a href="2476-clippy-uno.html">2476-clippy-uno</a></li><li><a href="2480-liballoc.html">2480-liballoc</a></li><li><a href="2495-min-rust-version.html">2495-min-rust-version</a></li><li><a href="2497-if-let-chains.html">2497-if-let-chains</a></li><li><a href="2500-needle.html">2500-needle</a></li><li><a href="2504-fix-error.html">2504-fix-error</a></li><li><a href="2514-union-initialization-and-drop.html">2514-union-initialization-and-drop</a></li><li><a href="2515-type_alias_impl_trait.html">2515-type_alias_impl_trait</a></li><li><a href="2521-c_void-reunification.html">2521-c_void-reunification</a></li><li><a href="2523-cfg-path-version.html">2523-cfg-path-version</a></li><li><a href="2526-const-wildcard.html">2526-const-wildcard</a></li><li><a href="2532-associated-type-defaults.html">2532-associated-type-defaults</a></li><li><a href="2535-or-patterns.html">2535-or-patterns</a></li><li><a href="2539-cfg_attr-multiple-attrs.html">2539-cfg_attr-multiple-attrs</a></li><li><a href="2561-future-possibilities.html">2561-future-possibilities</a></li><li><a href="2565-formal-function-parameter-attributes.html">2565-formal-function-parameter-attributes</a></li><li><a href="2570-linked-list-cursors.html">2570-linked-list-cursors</a></li><li><a href="2574-simd-ffi.html">2574-simd-ffi</a></li><li><a href="2582-raw-reference-mir-operator.html">2582-raw-reference-mir-operator</a></li><li><a href="2591-exhaustive-integer-pattern-matching.html">2591-exhaustive-integer-pattern-matching</a></li><li><a href="2592-futures.html">2592-futures</a></li><li><a href="2603-symbol-name-mangling-v2.html">2603-symbol-name-mangling-v2</a></li><li><a href="2627-raw-dylib-kind.html">2627-raw-dylib-kind</a></li><li><a href="2645-transparent-unions.html">2645-transparent-unions</a></li><li><a href="2657-roadmap-2019.html">2657-roadmap-2019</a></li><li><a href="2678-named-custom-cargo-profiles.html">2678-named-custom-cargo-profiles</a></li><li><a href="2689-compiler-team-contributors.html">2689-compiler-team-contributors</a></li><li><a href="2696-debug-map-key-value.html">2696-debug-map-key-value</a></li><li><a href="2700-associated-constants-on-ints.html">2700-associated-constants-on-ints</a></li><li><a href="2707-dotdot-patterns.html">2707-dotdot-patterns</a></li><li><a href="2795-format-args-implicit-identifiers.html">2795-format-args-implicit-identifiers</a></li><li><a href="2797-project-ffi-unwind.html">2797-project-ffi-unwind</a></li><li><a href="2835-project-safe-transmute.html">2835-project-safe-transmute</a></li><li><a href="2837-demote-apple-32bit.html">2837-demote-apple-32bit</a></li></ol>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">The Rust RFC Book</h1> 

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <ul>
<li>Feature Name: as_cell</li>
<li>Start Date: 2016-11-13</li>
<li>RFC PR: <a href="https://github.com/rust-lang/rfcs/pull/1789">rust-lang/rfcs#1789</a></li>
<li>Rust Issue: <a href="https://github.com/rust-lang/rust/issues/43038">rust-lang/rust#43038</a></li>
</ul>
<a class="header" href="#summary" id="summary"><h1>Summary</h1></a>
<ul>
<li>Change <code>Cell&lt;T&gt;</code> to allow <code>T: ?Sized</code>.</li>
<li>Guarantee that <code>T</code> and <code>Cell&lt;T&gt;</code> have the same memory layout.</li>
<li>Enable the following conversions through the std lib:
<ul>
<li><code>&amp;mut T -&gt; &amp;Cell&lt;T&gt; where T: ?Sized</code></li>
<li><code>&amp;Cell&lt;[T]&gt; -&gt; &amp;[Cell&lt;T&gt;]</code></li>
</ul>
</li>
</ul>
<blockquote>
<p>Note: https://github.com/rust-lang/rfcs/pull/1651 has been accepted recently,
so no <code>T: Copy</code> bound is needed anymore.</p>
</blockquote>
<a class="header" href="#motivation" id="motivation"><h1>Motivation</h1></a>
<p>Rust's iterators offer a safe, fast way to iterate over collections while avoiding
additional bound checks.</p>
<p>However, due to the borrow checker, they run into issues if we try to have
more than one iterator into the same data structure while mutating elements in it.</p>
<p>Wanting to do this is not that unusual for many low level algorithms
that deal with integers, floats or similar primitive data types.</p>
<p>For example, an algorithm might...</p>
<ul>
<li>For each element, access each other element.</li>
<li>For each element, access an element a number of elements before or after it.</li>
</ul>
<p>Todays answer for algorithms like that is to fall back to C-style
for loops and indexing, which might look like this...</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]

#fn main() {
let v: Vec&lt;i32&gt; = ...;

// example 1
for i in 0..v.len() {
    for j in 0..v.len() {
        v[j] = f(v[i], v[j]);
    }
}

// example 2
for i in n..v.len() {
    v[i] = g(v[i - n]);
}

#}</code></pre></pre>
<p>...but this reintroduces potential bound-checking costs.</p>
<p>The alternative, short of changing the actual algorithms involved, is to use
internal mutability to enable safe mutations even with overlapping shared views into the data:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
let v: Vec&lt;Cell&lt;i32&gt;&gt; = ...;

// example 1
for i in &amp;v {
    for j in &amp;v {
        j.set(f(i.get(), j.get()));
    }
}

// example 2
for (i, j) in v[n..].iter().zip(&amp;v) {
    i.set(g(g.get()));
}

#}</code></pre></pre>
<p>This has the advantages of allowing both bound-check free iteration and
aliasing references, but comes with restrictions that makes it not generally
applicable, namely:</p>
<ul>
<li>The need to change the definition of the data structure containing the data
(Which is not always possible because it might come from external code).</li>
<li>Loss of the ability to directly hand out <code>&amp;T</code> and <code>&amp;mut T</code> references to the data.</li>
</ul>
<p>This RFC proposes a way to address these in cases where <code>Cell&lt;T&gt;</code>
could be used by introducing simple conversions functions
to the standard library that allow the creation of shared borrowed
<code>Cell&lt;T&gt;</code>s from mutably borrowed <code>T</code>s.</p>
<p>This in turn allows the original data structure to remain unchanged,
while allowing to temporary opt-in to the <code>Cell</code> API as needed.
As an example, given <code>Cell::from_mut_slice(&amp;mut [T]) -&gt; &amp;[Cell&lt;T&gt;]</code>,
the previous examples can be written as this:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
let mut v: Vec&lt;i32&gt; = ...;

// convert the mutable borrow
let v_slice: &amp;[Cell&lt;T&gt;] = Cell::from_mut_slice(&amp;mut v);

// example 1
for i in v_slice {
    for j in v_slice {
        j.set(f(i.get(), j.get()));
    }
}

// example 2
for (i, j) in v_slice[n..].iter().zip(v_slice) {
    i.set(g(g.get()));
}

#}</code></pre></pre>
<a class="header" href="#detailed-design" id="detailed-design"><h1>Detailed design</h1></a>
<a class="header" href="#language" id="language"><h2>Language</h2></a>
<p>The core of this proposal is the ability to convert a <code>&amp;T</code> to a <code>&amp;Cell&lt;T&gt;</code>,
so in order for it to be safe, <strong>it needs to be guaranteed that
<code>T</code> and <code>Cell&lt;T&gt;</code> have the same memory layout</strong>, and that there are no codegen
issues based on viewing a reference to a type that does not contain a
<code>UnsafeCell</code> as a reference to a type that does contain a <code>UnsafeCell</code>.</p>
<p>As far as the author is aware, both should already implicitly
fall out of the semantic of <code>Cell</code> and Rusts/llvms notion of aliasing:</p>
<ul>
<li><code>Cell</code> is safe interior mutability based on memcopying the <code>T</code>,
and thus does not need additional fields or padding.</li>
<li><code>&amp;mut T -&gt; &amp;U</code> is a sub borrow, which prevents access to the original <code>&amp;mut T</code>
for its duration, thus no aliasing.</li>
</ul>
<a class="header" href="#std-library" id="std-library"><h2>Std library</h2></a>
<a class="header" href="#from_mut" id="from_mut"><h3><code>from_mut</code></h3></a>
<p>We add a constructor to the cell API that enables the <code>&amp;mut T -&gt; &amp;Cell&lt;T&gt;</code>
conversion, implemented with the equivalent of a <code>transmute()</code> of the two
pointers:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
impl&lt;T&gt; Cell&lt;T&gt; {
    fn from_mut&lt;'a&gt;(t: &amp;'a mut T) -&gt; &amp;'a Cell&lt;T&gt; {
        unsafe {
            &amp;*(t as *mut T as *const Cell&lt;T&gt;)
        }
    }
}
#}</code></pre></pre>
<p>In the future this could also be provided through <code>AsRef</code>, <code>Into</code> or <code>From</code>
impls.</p>
<a class="header" href="#unsized-cellt" id="unsized-cellt"><h3>Unsized <code>Cell&lt;T&gt;</code></h3></a>
<p>We extend <code>Cell&lt;T&gt;</code> to allow <code>T: ?Sized</code>, and move all compatible methods
to a less restricted impl block:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
pub struct Cell&lt;T: ?Sized&gt; {
    value: UnsafeCell&lt;T&gt;,
}

impl&lt;T: ?Sized&gt; Cell&lt;T&gt; {
    pub fn as_ptr(&amp;self) -&gt; *mut T;
    pub fn get_mut(&amp;mut self) -&gt; &amp;mut T;
    pub fn from_mut(value: &amp;mut T) -&gt; &amp;Cell&lt;T&gt;;
}
#}</code></pre></pre>
<p>This is purely done to enable cell slicing below, and should otherwise have no
effect on any existing code.</p>
<a class="header" href="#cell-slicing" id="cell-slicing"><h3>Cell Slicing</h3></a>
<p>We enable a conversion from <code>&amp;Cell&lt;[T]&gt;</code> to <code>&amp;[Cell&lt;T&gt;]</code>. This seems like it violates
the &quot;no interior references&quot; API of <code>Cell</code> at first glance, but is actually
safe:</p>
<ul>
<li>A slice represents a number of elements next to each other.
Thus, if <code>&amp;mut T -&gt; &amp;Cell&lt;T&gt;</code> is ok, then <code>&amp;mut [T] -&gt; &amp;[Cell&lt;T&gt;]</code> would be as well.
<code>&amp;mut [T] -&gt; &amp;Cell&lt;[T]&gt;</code> follows from <code>&amp;mut T -&gt; &amp;Cell&lt;T&gt;</code> through substitution,
so <code>&amp;Cell&lt;[T]&gt; &lt;-&gt; &amp;[Cell&lt;T&gt;]</code> has to be valid.</li>
<li>The API of a <code>Cell&lt;T&gt;</code> is to allow internal mutability through single-threaded
memcopies only. Since a memcopy is just a copy of all bits that make up a type,
it does not matter if we logically do a memcopy to all elements of a slice
through a <code>&amp;Cell&lt;[T]&gt;</code>, or just a memcopy to a single element through a
<code>&amp;Cell&lt;T&gt;</code>.</li>
<li>Yet another way to look at it is that if we created a <code>&amp;mut T</code> to each element
of a <code>&amp;mut [T]</code>, and converted each of them to a <code>&amp;Cell&lt;T&gt;</code>, their addresses
would allow &quot;stitching&quot; them back together to a single <code>&amp;[Cell&lt;T&gt;]</code></li>
</ul>
<p>For convenience, we expose this conversion by implementing <code>Index</code> for <code>Cell&lt;[T]&gt;</code>:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
impl&lt;T&gt; Index&lt;RangeFull&gt; for Cell&lt;[T]&gt; {
    type Output = [Cell&lt;T&gt;];

    fn index(&amp;self, _: RangeFull) -&gt; &amp;[Cell&lt;T&gt;] {
        unsafe {
            &amp;*(self as *const Cell&lt;[T]&gt; as *const [Cell&lt;T&gt;])
        }
    }
}

impl&lt;T&gt; Index&lt;Range&lt;usize&gt;&gt; for Cell&lt;[T]&gt; {
    type Output = [Cell&lt;T&gt;];

    fn index(&amp;self, idx: Range&lt;usize&gt;) -&gt; &amp;[Cell&lt;T&gt;] {
        &amp;self[..][idx]
    }
}

impl&lt;T&gt; Index&lt;RangeFrom&lt;usize&gt;&gt; for Cell&lt;[T]&gt; {
    type Output = [Cell&lt;T&gt;];

    fn index(&amp;self, idx: RangeFrom&lt;usize&gt;) -&gt; &amp;[Cell&lt;T&gt;] {
        &amp;self[..][idx]
    }
}

impl&lt;T&gt; Index&lt;RangeTo&lt;usize&gt;&gt; for Cell&lt;[T]&gt; {
    type Output = [Cell&lt;T&gt;];

    fn index(&amp;self, idx: RangeTo&lt;usize&gt;) -&gt; &amp;[Cell&lt;T&gt;] {
        &amp;self[..][idx]
    }
}

impl&lt;T&gt; Index&lt;usize&gt; for Cell&lt;[T]&gt; {
    type Output = Cell&lt;T&gt;;

    fn index(&amp;self, idx: usize) -&gt; &amp;Cell&lt;T&gt; {
        &amp;self[..][idx]
    }
}
#}</code></pre></pre>
<p>Using this, the motivation example can be written as such:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
let mut v: Vec&lt;i32&gt; = ...;

// convert the mutable borrow
let v_slice: &amp;[Cell&lt;T&gt;] = &amp;Cell::from_mut(&amp;mut v[..])[..];

// example 1
for i in v_slice {
    for j in v_slice {
        j.set(f(i.get(), j.get()));
    }
}

// example 2
for (i, j) in v_slice[n..].iter().zip(v_slice) {
    i.set(g(g.get()));
}

#}</code></pre></pre>
<a class="header" href="#possible-extensions" id="possible-extensions"><h2>Possible extensions</h2></a>
<p>The proposal only covers the base case <code>&amp;mut T -&gt; &amp;Cell&lt;T&gt;</code>
and the trivially implementable extension to <code>[T]</code>,
but in theory this conversion could be enabled for
many &quot;higher level mutable reference&quot; types, like for example
mutable iterators (with the goal of making them cloneable through this).</p>
<p>See https://play.rust-lang.org/?gist=d012cebf462841887323185cff8ccbcc&amp;version=stable&amp;backtrace=0 for
an example implementation and a more complex use case, and
https://crates.io/crates/alias for an existing crate providing these features.</p>
<a class="header" href="#how-we-teach-this" id="how-we-teach-this"><h1>How We Teach This</h1></a>
<blockquote>
<p>What names and terminology work best for these concepts and why?
How is this idea best presented—as a continuation of existing Rust patterns, or as a wholly new one?</p>
</blockquote>
<p>The API could be described as &quot;temporarily opting-in to internal mutability&quot;.
It would be a more flexible continuation of the existing usage of <code>Cell&lt;T&gt;</code>
since the <code>Cell&lt;T&gt;</code> no longer needs to exist in the original location if
you have mutable access to it.</p>
<blockquote>
<p>Would the acceptance of this proposal change how Rust is taught to new users at any level?
How should this feature be introduced and taught to existing Rust users?</p>
</blockquote>
<p>As it is, the API just provides a few neat conversion functions. Nevertheless,
with the legalization of the <code>&amp;mut T -&gt; &amp;Cell&lt;T&gt;</code> conversion there is the
potential for a major change in how accessors to data structures are provided:</p>
<p>In todays Rust, there are generally three different ways:</p>
<ul>
<li>Owned access that starts off with a <code>T</code> and yield <code>U</code>.</li>
<li>Shared borrowed access that starts off with a <code>&amp;T</code> and yields <code>&amp;U</code>.</li>
<li>Mutable borrowed access that starts off with a <code>&amp;mut T</code> and yields <code>&amp;mut U</code>.</li>
</ul>
<p>With this change, it would be possible in many cases to add a fourth accessor:</p>
<ul>
<li>Shared borrowed cell access that starts off with a <code>&amp;mut T</code> and yields <code>&amp;Cell&lt;U&gt;</code>.</li>
</ul>
<p>For example, today there exist:</p>
<ul>
<li><code>Vec&lt;T&gt; -&gt; std::vec::IntoIter&lt;T&gt;</code>, which yields <code>T</code> values and is cloneable.</li>
<li><code>&amp;[T] -&gt; std::slice::Iter&lt;T&gt;</code>, which yields <code>&amp;T</code> values and is
cloneable because it does a shared borrow.</li>
<li><code>&amp;mut [T] -&gt; std::slice::IterMut&lt;T&gt;</code>, which yields <code>&amp;mut T</code> values and is
not cloneable because it does a mutable borrow.</li>
</ul>
<p>We could then add a fourth iterator like this:</p>
<ul>
<li><code>&amp;mut [T] -&gt; std::slice::CellIter&lt;T&gt;</code>, which yields <code>&amp;Cell&lt;T&gt;</code> values and is
cloneable because it does a shared borrow.</li>
</ul>
<p>So there is the potential that we go away from teaching the &quot;rule of three&quot;
of ownership and change it to a &quot;rule of four&quot;.</p>
<blockquote>
<p>What additions or changes to the Rust Reference, <em>The Rust Programming Language</em>, and/or <em>Rust by Example</em> does it entail?</p>
</blockquote>
<ul>
<li>The reference should explain that the <code>&amp;mut T -&gt; &amp;Cell&lt;T&gt;</code> conversion,
or specifically the <code>&amp;mut T -&gt; &amp;UnsafeCell&lt;T&gt;</code> conversion is fine.</li>
<li>The book could use the API introduced here if it talks about internal mutability,
and use it as a &quot;temporary opt-in&quot; example.</li>
<li>Rust by Example could have a few basic examples of situations where this API
is useful, eg the ones mention in the motivation section above.</li>
</ul>
<a class="header" href="#drawbacks" id="drawbacks"><h1>Drawbacks</h1></a>
<blockquote>
<p>Why should we <em>not</em> do this?</p>
</blockquote>
<ul>
<li>More complexity around the <code>Cell</code> API.</li>
<li><code>T</code> -&gt; <code>Cell&lt;T&gt;</code> transmute compatibility might not be a desired guarantee.</li>
</ul>
<a class="header" href="#alternatives" id="alternatives"><h1>Alternatives</h1></a>
<a class="header" href="#removing-cell-slicing" id="removing-cell-slicing"><h2>Removing cell slicing</h2></a>
<p>Instead of allowing unsized types in <code>Cell</code> and adding the <code>Index</code> impls,
there could just be a single <code>&amp;mut [T] -&gt; &amp;[Cell&lt;T&gt;]</code> conversions function:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
impl&lt;T&gt; Cell&lt;T&gt; {
    /// [...]

    fn from_mut_slice&lt;'a&gt;(t: &amp;'a mut [T]) -&gt; &amp;'a [Cell&lt;T&gt;] {
        unsafe {
            &amp;*(t as *mut [T] as *const [Cell&lt;T&gt;])
        }
    }
}
#}</code></pre></pre>
<p>Usage:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
let mut v: Vec&lt;i32&gt; = ...;

// convert the mutable borrow
let v_slice: &amp;[Cell&lt;T&gt;] = Cell::from_mut_slice(&amp;mut v);

// example 1
for i in v_slice {
    for j in v_slice {
        j.set(f(i.get(), j.get()));
    }
}

// example 2
for (i, j) in v_slice[n..].iter().zip(v_slice) {
    i.set(g(g.get()));
}
#}</code></pre></pre>
<p>This would be less modular than the <code>&amp;mut [T] -&gt; &amp;Cell&lt;[T]&gt; -&gt; &amp;[Cell&lt;T&gt;]</code>
conversions steps, while still offering essentially the same API.</p>
<a class="header" href="#just-the-language-guarantee" id="just-the-language-guarantee"><h2>Just the language guarantee</h2></a>
<p>The conversion could be guaranteed as correct, but not be provided by std
itself. This would serve as legitimization of external implementations like
<a href="https://crates.io/crates/alias">alias</a>.</p>
<a class="header" href="#no-guarantees" id="no-guarantees"><h2>No guarantees</h2></a>
<p>If the safety guarantees of the conversion can not be granted,
code would have to use direct indexing as today, with either possible
bound checking costs or the use of unsafe code to avoid them.</p>
<a class="header" href="#replacing-index-impls-with-deref" id="replacing-index-impls-with-deref"><h2>Replacing <code>Index</code> impls with <code>Deref</code></h2></a>
<p>Instead of the <code>Index</code> impls, have only this <code>Deref</code> impl:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
impl&lt;T&gt; Deref for Cell&lt;[T]&gt; {
    type Target = [Cell&lt;T&gt;];

    fn deref(&amp;self) -&gt; &amp;[Cell&lt;T&gt;] {
        unsafe {
            &amp;*(self as *const Cell&lt;[T]&gt; as *const [Cell&lt;T&gt;])
        }
    }
}
#}</code></pre></pre>
<p>Pro:</p>
<ul>
<li>Automatic conversion due to deref coercions and auto deref.</li>
<li>Less redundancy since we don't repeat the slicing impls of <code>[T]</code>.</li>
</ul>
<p>Cons:</p>
<ul>
<li><code>Cell&lt;[T]&gt; -&gt; [Cell&lt;T&gt;]</code> conversion does not seem like a good usecase
for <code>Deref</code>, since <code>Cell&lt;[T]&gt;</code> isn't a smartpointer.</li>
</ul>
<a class="header" href="#cast-to-mut-cellt-instead-of-cellt" id="cast-to-mut-cellt-instead-of-cellt"><h2>Cast to <code>&amp;mut Cell&lt;T&gt;</code> instead of <code>&amp;Cell&lt;T&gt;</code></h2></a>
<p>Nothing that makes the <code>&amp;mut T -&gt; &amp;Cell&lt;T&gt;</code> conversion safe would prevent
<code>&amp;mut T -&gt; &amp;mut Cell&lt;T&gt;</code> from being safe either, and the latter can be
trivially turned into a <code>&amp;Cell&lt;T&gt;</code> while also allowing mutable access - eg to
call <code>Cell::as_mut()</code> to conversion back again.</p>
<p>Similar to that, there could also be a way to turn a <code>&amp;mut [Cell&lt;T&gt;]</code> back
into a <code>&amp;mut [T]</code>.</p>
<p>However, this does not seem to be actually useful since the only reason to use
this API is to make use of shared internal mutability.</p>
<a class="header" href="#exposing-the-functions-differently" id="exposing-the-functions-differently"><h2>Exposing the functions differently</h2></a>
<p>Instead of <code>Cell</code> constructors, we could just have freestanding functions
in, say, <code>std::cell</code>:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
fn ref_as_cell&lt;T&gt;(t: &amp;mut T) -&gt; &amp;Cell&lt;T&gt; {
    unsafe {
        &amp;*(t as *mut T as *const Cell&lt;T&gt;)
    }
}

fn cell_slice&lt;T&gt;(t: &amp;Cell&lt;[T]&gt;) -&gt; &amp;[Cell&lt;T&gt;] {
    unsafe {
        &amp;*(t as *const Cell&lt;[T]&gt; as *const [Cell&lt;T&gt;])
    }
}
#}</code></pre></pre>
<p>On the opposite spectrum, and should this feature end up being used
somewhat commonly,
we could provide the conversions by dedicated traits,
possibly in the prelude, or use the std coherence hack to implement
them directly on <code>&amp;mut T</code> and <code>&amp;mut [T]</code>:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
trait AsCell {
    type Cell;
    fn as_cell(self) -&gt; Self::Cell;
}

impl&lt;'a, T&gt; AsCell for &amp;'a mut T {
    type Cell = &amp;'a Cell&lt;T&gt;;
    fn as_cell(self) -&gt; Self::Cell {
        unsafe {
            &amp;*(self as *mut T as *const Cell&lt;T&gt;)
        }
    }
}
#}</code></pre></pre>
<p>But given the issues of adding methods to pointer-like types,
this approach in general would probably be not a good idea
(See the situation with <code>Rc</code> and <code>Arc</code>).</p>
<a class="header" href="#unresolved-questions" id="unresolved-questions"><h1>Unresolved questions</h1></a>
<p>None so far.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="1774-roadmap-2017.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="1824-crates.io-default-ranking.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="1774-roadmap-2017.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="1824-crates.io-default-ranking.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
