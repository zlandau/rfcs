<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>1422-pub-restricted - The Rust RFC Book</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body class="light">
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { } 
            if (theme === null || theme === undefined) { theme = default_theme; }
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <ol class="chapter"><li class="affix"><a href="introduction.html">Introduction</a></li><li><a href="0001-private-fields.html">0001-private-fields</a></li><li><a href="0002-rfc-process.html">0002-rfc-process</a></li><li><a href="0003-attribute-usage.html">0003-attribute-usage</a></li><li><a href="0008-new-intrinsics.html">0008-new-intrinsics</a></li><li><a href="0016-more-attributes.html">0016-more-attributes</a></li><li><a href="0019-opt-in-builtin-traits.html">0019-opt-in-builtin-traits</a></li><li><a href="0026-remove-priv.html">0026-remove-priv</a></li><li><a href="0034-bounded-type-parameters.html">0034-bounded-type-parameters</a></li><li><a href="0040-libstd-facade.html">0040-libstd-facade</a></li><li><a href="0042-regexps.html">0042-regexps</a></li><li><a href="0048-traits.html">0048-traits</a></li><li><a href="0049-match-arm-attributes.html">0049-match-arm-attributes</a></li><li><a href="0050-assert.html">0050-assert</a></li><li><a href="0059-remove-tilde.html">0059-remove-tilde</a></li><li><a href="0060-rename-strbuf.html">0060-rename-strbuf</a></li><li><a href="0063-module-file-system-hierarchy.html">0063-module-file-system-hierarchy</a></li><li><a href="0066-better-temporary-lifetimes.html">0066-better-temporary-lifetimes</a></li><li><a href="0068-const-unsafe-pointers.html">0068-const-unsafe-pointers</a></li><li><a href="0069-ascii-literals.html">0069-ascii-literals</a></li><li><a href="0071-const-block-expr.html">0071-const-block-expr</a></li><li><a href="0079-undefined-struct-layout.html">0079-undefined-struct-layout</a></li><li><a href="0085-pattern-macros.html">0085-pattern-macros</a></li><li><a href="0086-plugin-registrar.html">0086-plugin-registrar</a></li><li><a href="0087-trait-bounds-with-plus.html">0087-trait-bounds-with-plus</a></li><li><a href="0089-loadable-lints.html">0089-loadable-lints</a></li><li><a href="0090-lexical-syntax-simplification.html">0090-lexical-syntax-simplification</a></li><li><a href="0092-struct-grammar.html">0092-struct-grammar</a></li><li><a href="0093-remove-format-intl.html">0093-remove-format-intl</a></li><li><a href="0100-partial-cmp.html">0100-partial-cmp</a></li><li><a href="0107-pattern-guards-with-bind-by-move.html">0107-pattern-guards-with-bind-by-move</a></li><li><a href="0109-remove-crate-id.html">0109-remove-crate-id</a></li><li><a href="0111-index-traits.html">0111-index-traits</a></li><li><a href="0112-remove-cross-borrowing.html">0112-remove-cross-borrowing</a></li><li><a href="0114-closures.html">0114-closures</a></li><li><a href="0115-rm-integer-fallback.html">0115-rm-integer-fallback</a></li><li><a href="0116-no-module-shadowing.html">0116-no-module-shadowing</a></li><li><a href="0123-share-to-threadsafe.html">0123-share-to-threadsafe</a></li><li><a href="0130-box-not-special.html">0130-box-not-special</a></li><li><a href="0131-target-specification.html">0131-target-specification</a></li><li><a href="0132-ufcs.html">0132-ufcs</a></li><li><a href="0135-where.html">0135-where</a></li><li><a href="0136-no-privates-in-public.html">0136-no-privates-in-public</a></li><li><a href="0139-remove-cross-borrowing-entirely.html">0139-remove-cross-borrowing-entirely</a></li><li><a href="0141-lifetime-elision.html">0141-lifetime-elision</a></li><li><a href="0151-capture-by-value.html">0151-capture-by-value</a></li><li><a href="0155-anonymous-impl-only-in-same-module.html">0155-anonymous-impl-only-in-same-module</a></li><li><a href="0160-if-let.html">0160-if-let</a></li><li><a href="0164-feature-gate-slice-pats.html">0164-feature-gate-slice-pats</a></li><li><a href="0168-mod.html">0168-mod</a></li><li><a href="0169-use-path-as-id.html">0169-use-path-as-id</a></li><li><a href="0179-and-mut-patterns.html">0179-and-mut-patterns</a></li><li><a href="0184-tuple-accessors.html">0184-tuple-accessors</a></li><li><a href="0192-bounds-on-object-and-generic-types.html">0192-bounds-on-object-and-generic-types</a></li><li><a href="0194-cfg-syntax.html">0194-cfg-syntax</a></li><li><a href="0195-associated-items.html">0195-associated-items</a></li><li><a href="0198-slice-notation.html">0198-slice-notation</a></li><li><a href="0199-ownership-variants.html">0199-ownership-variants</a></li><li><a href="0201-error-chaining.html">0201-error-chaining</a></li><li><a href="0202-subslice-syntax-change.html">0202-subslice-syntax-change</a></li><li><a href="0212-restore-int-fallback.html">0212-restore-int-fallback</a></li><li><a href="0213-defaulted-type-params.html">0213-defaulted-type-params</a></li><li><a href="0214-while-let.html">0214-while-let</a></li><li><a href="0216-collection-views.html">0216-collection-views</a></li><li><a href="0218-empty-struct-with-braces.html">0218-empty-struct-with-braces</a></li><li><a href="0221-panic.html">0221-panic</a></li><li><a href="0230-remove-runtime.html">0230-remove-runtime</a></li><li><a href="0231-upvar-capture-inference.html">0231-upvar-capture-inference</a></li><li><a href="0234-variants-namespace.html">0234-variants-namespace</a></li><li><a href="0235-collections-conventions.html">0235-collections-conventions</a></li><li><a href="0236-error-conventions.html">0236-error-conventions</a></li><li><a href="0240-unsafe-api-location.html">0240-unsafe-api-location</a></li><li><a href="0241-deref-conversions.html">0241-deref-conversions</a></li><li><a href="0243-trait-based-exception-handling.html">0243-trait-based-exception-handling</a></li><li><a href="0246-const-vs-static.html">0246-const-vs-static</a></li><li><a href="0255-object-safety.html">0255-object-safety</a></li><li><a href="0256-remove-refcounting-gc-of-t.html">0256-remove-refcounting-gc-of-t</a></li><li><a href="0320-nonzeroing-dynamic-drop.html">0320-nonzeroing-dynamic-drop</a></li><li><a href="0326-restrict-xXX-to-ascii.html">0326-restrict-xXX-to-ascii</a></li><li><a href="0339-statically-sized-literals.html">0339-statically-sized-literals</a></li><li><a href="0341-remove-virtual-structs.html">0341-remove-virtual-structs</a></li><li><a href="0342-keywords.html">0342-keywords</a></li><li><a href="0344-conventions-galore.html">0344-conventions-galore</a></li><li><a href="0356-no-module-prefixes.html">0356-no-module-prefixes</a></li><li><a href="0369-num-reform.html">0369-num-reform</a></li><li><a href="0378-expr-macros.html">0378-expr-macros</a></li><li><a href="0379-remove-reflection.html">0379-remove-reflection</a></li><li><a href="0380-stabilize-std-fmt.html">0380-stabilize-std-fmt</a></li><li><a href="0385-module-system-cleanup.html">0385-module-system-cleanup</a></li><li><a href="0387-higher-ranked-trait-bounds.html">0387-higher-ranked-trait-bounds</a></li><li><a href="0390-enum-namespacing.html">0390-enum-namespacing</a></li><li><a href="0401-coercions.html">0401-coercions</a></li><li><a href="0403-cargo-build-command.html">0403-cargo-build-command</a></li><li><a href="0404-change-prefer-dynamic.html">0404-change-prefer-dynamic</a></li><li><a href="0418-struct-variants.html">0418-struct-variants</a></li><li><a href="0430-finalizing-naming-conventions.html">0430-finalizing-naming-conventions</a></li><li><a href="0438-precedence-of-plus.html">0438-precedence-of-plus</a></li><li><a href="0439-cmp-ops-reform.html">0439-cmp-ops-reform</a></li><li><a href="0445-extension-trait-conventions.html">0445-extension-trait-conventions</a></li><li><a href="0446-es6-unicode-escapes.html">0446-es6-unicode-escapes</a></li><li><a href="0447-no-unused-impl-parameters.html">0447-no-unused-impl-parameters</a></li><li><a href="0450-un-feature-gate-some-more-gates.html">0450-un-feature-gate-some-more-gates</a></li><li><a href="0453-macro-reform.html">0453-macro-reform</a></li><li><a href="0458-send-improvements.html">0458-send-improvements</a></li><li><a href="0459-disallow-shadowing.html">0459-disallow-shadowing</a></li><li><a href="0461-tls-overhaul.html">0461-tls-overhaul</a></li><li><a href="0463-future-proof-literal-suffixes.html">0463-future-proof-literal-suffixes</a></li><li><a href="0469-feature-gate-box-patterns.html">0469-feature-gate-box-patterns</a></li><li><a href="0474-path-reform.html">0474-path-reform</a></li><li><a href="0486-std-ascii-reform.html">0486-std-ascii-reform</a></li><li><a href="0490-dst-syntax.html">0490-dst-syntax</a></li><li><a href="0494-c_str-and-c_vec-stability.html">0494-c_str-and-c_vec-stability</a></li><li><a href="0495-array-pattern-changes.html">0495-array-pattern-changes</a></li><li><a href="0501-consistent_no_prelude_attributes.html">0501-consistent_no_prelude_attributes</a></li><li><a href="0503-prelude-stabilization.html">0503-prelude-stabilization</a></li><li><a href="0504-show-stabilization.html">0504-show-stabilization</a></li><li><a href="0505-api-comment-conventions.html">0505-api-comment-conventions</a></li><li><a href="0507-release-channels.html">0507-release-channels</a></li><li><a href="0509-collections-reform-part-2.html">0509-collections-reform-part-2</a></li><li><a href="0517-io-os-reform.html">0517-io-os-reform</a></li><li><a href="0520-new-array-repeat-syntax.html">0520-new-array-repeat-syntax</a></li><li><a href="0522-self-impl.html">0522-self-impl</a></li><li><a href="0526-fmt-text-writer.html">0526-fmt-text-writer</a></li><li><a href="0528-string-patterns.html">0528-string-patterns</a></li><li><a href="0529-conversion-traits.html">0529-conversion-traits</a></li><li><a href="0531-define-rfc-scope.html">0531-define-rfc-scope</a></li><li><a href="0532-self-in-use.html">0532-self-in-use</a></li><li><a href="0533-no-array-elem-moves.html">0533-no-array-elem-moves</a></li><li><a href="0534-deriving2derive.html">0534-deriving2derive</a></li><li><a href="0544-rename-int-uint.html">0544-rename-int-uint</a></li><li><a href="0546-Self-not-sized-by-default.html">0546-Self-not-sized-by-default</a></li><li><a href="0550-macro-future-proofing.html">0550-macro-future-proofing</a></li><li><a href="0556-raw-lifetime.html">0556-raw-lifetime</a></li><li><a href="0558-require-parentheses-for-chained-comparisons.html">0558-require-parentheses-for-chained-comparisons</a></li><li><a href="0560-integer-overflow.html">0560-integer-overflow</a></li><li><a href="0563-remove-ndebug.html">0563-remove-ndebug</a></li><li><a href="0565-show-string-guidelines.html">0565-show-string-guidelines</a></li><li><a href="0572-rustc-attribute.html">0572-rustc-attribute</a></li><li><a href="0574-drain-range.html">0574-drain-range</a></li><li><a href="0580-rename-collections.html">0580-rename-collections</a></li><li><a href="0587-fn-return-should-be-an-associated-type.html">0587-fn-return-should-be-an-associated-type</a></li><li><a href="0592-c-str-deref.html">0592-c-str-deref</a></li><li><a href="0593-forbid-Self-definitions.html">0593-forbid-Self-definitions</a></li><li><a href="0599-default-object-bound.html">0599-default-object-bound</a></li><li><a href="0601-replace-be-with-become.html">0601-replace-be-with-become</a></li><li><a href="0639-discriminant-intrinsic.html">0639-discriminant-intrinsic</a></li><li><a href="0640-debug-improvements.html">0640-debug-improvements</a></li><li><a href="0702-rangefull-expression.html">0702-rangefull-expression</a></li><li><a href="0735-allow-inherent-impls-anywhere.html">0735-allow-inherent-impls-anywhere</a></li><li><a href="0736-privacy-respecting-fru.html">0736-privacy-respecting-fru</a></li><li><a href="0738-variance.html">0738-variance</a></li><li><a href="0769-sound-generic-drop.html">0769-sound-generic-drop</a></li><li><a href="0771-std-iter-once.html">0771-std-iter-once</a></li><li><a href="0803-type-ascription.html">0803-type-ascription</a></li><li><a href="0809-box-and-in-for-stdlib.html">0809-box-and-in-for-stdlib</a></li><li><a href="0823-hash-simplification.html">0823-hash-simplification</a></li><li><a href="0832-from-elem-with-love.html">0832-from-elem-with-love</a></li><li><a href="0839-embrace-extend-extinguish.html">0839-embrace-extend-extinguish</a></li><li><a href="0840-no-panic-in-c-string.html">0840-no-panic-in-c-string</a></li><li><a href="0873-type-macros.html">0873-type-macros</a></li><li><a href="0879-small-base-lexing.html">0879-small-base-lexing</a></li><li><a href="0888-compiler-fence-intrinsics.html">0888-compiler-fence-intrinsics</a></li><li><a href="0909-move-thread-local-to-std-thread.html">0909-move-thread-local-to-std-thread</a></li><li><a href="0911-const-fn.html">0911-const-fn</a></li><li><a href="0921-entry_v3.html">0921-entry_v3</a></li><li><a href="0940-hyphens-considered-harmful.html">0940-hyphens-considered-harmful</a></li><li><a href="0953-op-assign.html">0953-op-assign</a></li><li><a href="0968-closure-return-type-syntax.html">0968-closure-return-type-syntax</a></li><li><a href="0979-align-splitn-with-other-languages.html">0979-align-splitn-with-other-languages</a></li><li><a href="0980-read-exact.html">0980-read-exact</a></li><li><a href="0982-dst-coercion.html">0982-dst-coercion</a></li><li><a href="1011-process.exit.html">1011-process.exit</a></li><li><a href="1014-stdout-existential-crisis.html">1014-stdout-existential-crisis</a></li><li><a href="1023-rebalancing-coherence.html">1023-rebalancing-coherence</a></li><li><a href="1030-prelude-additions.html">1030-prelude-additions</a></li><li><a href="1040-duration-reform.html">1040-duration-reform</a></li><li><a href="1044-io-fs-2.1.html">1044-io-fs-2.1</a></li><li><a href="1047-socket-timeouts.html">1047-socket-timeouts</a></li><li><a href="1048-rename-soft-link-to-symlink.html">1048-rename-soft-link-to-symlink</a></li><li><a href="1054-str-words.html">1054-str-words</a></li><li><a href="1057-io-error-sync.html">1057-io-error-sync</a></li><li><a href="1058-slice-tail-redesign.html">1058-slice-tail-redesign</a></li><li><a href="1066-safe-mem-forget.html">1066-safe-mem-forget</a></li><li><a href="1068-rust-governance.html">1068-rust-governance</a></li><li><a href="1096-remove-static-assert.html">1096-remove-static-assert</a></li><li><a href="1102-rename-connect-to-join.html">1102-rename-connect-to-join</a></li><li><a href="1105-api-evolution.html">1105-api-evolution</a></li><li><a href="1119-result-expect.html">1119-result-expect</a></li><li><a href="1122-language-semver.html">1122-language-semver</a></li><li><a href="1123-str-split-at.html">1123-str-split-at</a></li><li><a href="1131-likely-intrinsic.html">1131-likely-intrinsic</a></li><li><a href="1135-raw-pointer-comparisons.html">1135-raw-pointer-comparisons</a></li><li><a href="1152-slice-string-symmetry.html">1152-slice-string-symmetry</a></li><li><a href="1156-adjust-default-object-bounds.html">1156-adjust-default-object-bounds</a></li><li><a href="1174-into-raw-fd-socket-handle-traits.html">1174-into-raw-fd-socket-handle-traits</a></li><li><a href="1183-swap-out-jemalloc.html">1183-swap-out-jemalloc</a></li><li><a href="1184-stabilize-no_std.html">1184-stabilize-no_std</a></li><li><a href="1191-hir.html">1191-hir</a></li><li><a href="1192-inclusive-ranges.html">1192-inclusive-ranges</a></li><li><a href="1193-cap-lints.html">1193-cap-lints</a></li><li><a href="1194-set-recovery.html">1194-set-recovery</a></li><li><a href="1199-simd-infrastructure.html">1199-simd-infrastructure</a></li><li><a href="1200-cargo-install.html">1200-cargo-install</a></li><li><a href="1201-naked-fns.html">1201-naked-fns</a></li><li><a href="1210-impl-specialization.html">1210-impl-specialization</a></li><li><a href="1211-mir.html">1211-mir</a></li><li><a href="1212-line-endings.html">1212-line-endings</a></li><li><a href="1214-projections-lifetimes-and-wf.html">1214-projections-lifetimes-and-wf</a></li><li><a href="1216-bang-type.html">1216-bang-type</a></li><li><a href="1219-use-group-as.html">1219-use-group-as</a></li><li><a href="1228-placement-left-arrow.html">1228-placement-left-arrow</a></li><li><a href="1229-compile-time-asserts.html">1229-compile-time-asserts</a></li><li><a href="1236-stabilize-catch-panic.html">1236-stabilize-catch-panic</a></li><li><a href="1238-nonparametric-dropck.html">1238-nonparametric-dropck</a></li><li><a href="1240-repr-packed-unsafe-ref.html">1240-repr-packed-unsafe-ref</a></li><li><a href="1241-no-wildcard-deps.html">1241-no-wildcard-deps</a></li><li><a href="1242-rust-lang-crates.html">1242-rust-lang-crates</a></li><li><a href="1252-open-options.html">1252-open-options</a></li><li><a href="1257-drain-range-2.html">1257-drain-range-2</a></li><li><a href="1260-main-reexport.html">1260-main-reexport</a></li><li><a href="1268-allow-overlapping-impls-on-marker-traits.html">1268-allow-overlapping-impls-on-marker-traits</a></li><li><a href="1270-deprecation.html">1270-deprecation</a></li><li><a href="1288-time-improvements.html">1288-time-improvements</a></li><li><a href="1291-promote-libc.html">1291-promote-libc</a></li><li><a href="1298-incremental-compilation.html">1298-incremental-compilation</a></li><li><a href="1300-intrinsic-semantics.html">1300-intrinsic-semantics</a></li><li><a href="1307-osstring-methods.html">1307-osstring-methods</a></li><li><a href="1317-ide.html">1317-ide</a></li><li><a href="1327-dropck-param-eyepatch.html">1327-dropck-param-eyepatch</a></li><li><a href="1328-global-panic-handler.html">1328-global-panic-handler</a></li><li><a href="1331-grammar-is-canonical.html">1331-grammar-is-canonical</a></li><li><a href="1358-repr-align.html">1358-repr-align</a></li><li><a href="1359-process-ext-unix.html">1359-process-ext-unix</a></li><li><a href="1361-cargo-cfg-dependencies.html">1361-cargo-cfg-dependencies</a></li><li><a href="1398-kinds-of-allocators.html">1398-kinds-of-allocators</a></li><li><a href="1399-repr-pack.html">1399-repr-pack</a></li><li><a href="1414-rvalue_static_promotion.html">1414-rvalue_static_promotion</a></li><li><a href="1415-trim-std-os.html">1415-trim-std-os</a></li><li><a href="1419-slice-copy.html">1419-slice-copy</a></li><li><a href="1422-pub-restricted.html" class="active">1422-pub-restricted</a></li><li><a href="1432-replace-slice.html">1432-replace-slice</a></li><li><a href="1434-contains-method-for-ranges.html">1434-contains-method-for-ranges</a></li><li><a href="1440-drop-types-in-const.html">1440-drop-types-in-const</a></li><li><a href="1443-extended-compare-and-swap.html">1443-extended-compare-and-swap</a></li><li><a href="1444-union.html">1444-union</a></li><li><a href="1445-restrict-constants-in-patterns.html">1445-restrict-constants-in-patterns</a></li><li><a href="1461-net2-mutators.html">1461-net2-mutators</a></li><li><a href="1467-volatile.html">1467-volatile</a></li><li><a href="1479-unix-socket.html">1479-unix-socket</a></li><li><a href="1492-dotdot-in-patterns.html">1492-dotdot-in-patterns</a></li><li><a href="1498-ipv6addr-octets.html">1498-ipv6addr-octets</a></li><li><a href="1504-int128.html">1504-int128</a></li><li><a href="1506-adt-kinds.html">1506-adt-kinds</a></li><li><a href="1510-cdylib.html">1510-cdylib</a></li><li><a href="1513-less-unwinding.html">1513-less-unwinding</a></li><li><a href="1521-copy-clone-semantics.html">1521-copy-clone-semantics</a></li><li><a href="1522-conservative-impl-trait.html">1522-conservative-impl-trait</a></li><li><a href="1525-cargo-workspace.html">1525-cargo-workspace</a></li><li><a href="1535-stable-overflow-checks.html">1535-stable-overflow-checks</a></li><li><a href="1542-try-from.html">1542-try-from</a></li><li><a href="1543-integer_atomics.html">1543-integer_atomics</a></li><li><a href="1548-global-asm.html">1548-global-asm</a></li><li><a href="1552-contains-method-for-various-collections.html">1552-contains-method-for-various-collections</a></li><li><a href="1558-closure-to-fn-coercion.html">1558-closure-to-fn-coercion</a></li><li><a href="1559-attributes-with-literals.html">1559-attributes-with-literals</a></li><li><a href="1560-name-resolution.html">1560-name-resolution</a></li><li><a href="1561-macro-naming.html">1561-macro-naming</a></li><li><a href="1566-proc-macros.html">1566-proc-macros</a></li><li><a href="1567-long-error-codes-explanation-normalization.html">1567-long-error-codes-explanation-normalization</a></li><li><a href="1574-more-api-documentation-conventions.html">1574-more-api-documentation-conventions</a></li><li><a href="1576-macros-literal-matcher.html">1576-macros-literal-matcher</a></li><li><a href="1581-fused-iterator.html">1581-fused-iterator</a></li><li><a href="1584-macros.html">1584-macros</a></li><li><a href="1589-rustc-bug-fix-procedure.html">1589-rustc-bug-fix-procedure</a></li><li><a href="1590-macro-lifetimes.html">1590-macro-lifetimes</a></li><li><a href="1598-generic_associated_types.html">1598-generic_associated_types</a></li><li><a href="1607-style-rfcs.html">1607-style-rfcs</a></li><li><a href="1618-ergonomic-format-args.html">1618-ergonomic-format-args</a></li><li><a href="1620-regex-1.0.html">1620-regex-1.0</a></li><li><a href="1623-static.html">1623-static</a></li><li><a href="1624-loop-break-value.html">1624-loop-break-value</a></li><li><a href="1636-document_all_features.html">1636-document_all_features</a></li><li><a href="1640-duration-checked-sub.html">1640-duration-checked-sub</a></li><li><a href="1643-memory-model-strike-team.html">1643-memory-model-strike-team</a></li><li><a href="1644-default-and-expanded-rustc-errors.html">1644-default-and-expanded-rustc-errors</a></li><li><a href="1647-allow-self-in-where-clauses.html">1647-allow-self-in-where-clauses</a></li><li><a href="1649-atomic-access.html">1649-atomic-access</a></li><li><a href="1651-movecell.html">1651-movecell</a></li><li><a href="1653-assert_ne.html">1653-assert_ne</a></li><li><a href="1660-try-borrow.html">1660-try-borrow</a></li><li><a href="1665-windows-subsystem.html">1665-windows-subsystem</a></li><li><a href="1679-panic-safe-slicing.html">1679-panic-safe-slicing</a></li><li><a href="1681-macros-1.1.html">1681-macros-1.1</a></li><li><a href="1682-field-init-shorthand.html">1682-field-init-shorthand</a></li><li><a href="1683-docs-team.html">1683-docs-team</a></li><li><a href="1685-deprecate-anonymous-parameters.html">1685-deprecate-anonymous-parameters</a></li><li><a href="1695-add-error-macro.html">1695-add-error-macro</a></li><li><a href="1696-discriminant.html">1696-discriminant</a></li><li><a href="1717-dllimport.html">1717-dllimport</a></li><li><a href="1721-crt-static.html">1721-crt-static</a></li><li><a href="1725-unaligned-access.html">1725-unaligned-access</a></li><li><a href="1728-north-star.html">1728-north-star</a></li><li><a href="1733-trait-alias.html">1733-trait-alias</a></li><li><a href="1758-repr-transparent.html">1758-repr-transparent</a></li><li><a href="1774-roadmap-2017.html">1774-roadmap-2017</a></li><li><a href="1789-as-cell.html">1789-as-cell</a></li><li><a href="1824-crates.io-default-ranking.html">1824-crates.io-default-ranking</a></li><li><a href="1826-change-doc-default-urls.html">1826-change-doc-default-urls</a></li><li><a href="1828-rust-bookshelf.html">1828-rust-bookshelf</a></li><li><a href="1845-shared-from-slice.html">1845-shared-from-slice</a></li><li><a href="1849-non-static-type-id.html">1849-non-static-type-id</a></li><li><a href="1857-stabilize-drop-order.html">1857-stabilize-drop-order</a></li><li><a href="1859-try-trait.html">1859-try-trait</a></li><li><a href="1860-manually-drop.html">1860-manually-drop</a></li><li><a href="1861-extern-types.html">1861-extern-types</a></li><li><a href="1866-more-readable-assert-eq.html">1866-more-readable-assert-eq</a></li><li><a href="1868-portability-lint.html">1868-portability-lint</a></li><li><a href="1869-eprintln.html">1869-eprintln</a></li><li><a href="1884-unstable-sort.html">1884-unstable-sort</a></li><li><a href="1892-uninitialized-uninhabited.html">1892-uninitialized-uninhabited</a></li><li><a href="1909-unsized-rvalues.html">1909-unsized-rvalues</a></li><li><a href="1925-optional-match-vert.html">1925-optional-match-vert</a></li><li><a href="1937-ques-in-main.html">1937-ques-in-main</a></li><li><a href="1940-must-use-functions.html">1940-must-use-functions</a></li><li><a href="1946-intra-rustdoc-links.html">1946-intra-rustdoc-links</a></li><li><a href="1951-expand-impl-trait.html">1951-expand-impl-trait</a></li><li><a href="1961-clamp.html">1961-clamp</a></li><li><a href="1966-unsafe-pointer-reform.html">1966-unsafe-pointer-reform</a></li><li><a href="1969-cargo-prepublish.html">1969-cargo-prepublish</a></li><li><a href="1974-global-allocators.html">1974-global-allocators</a></li><li><a href="1977-public-private-dependencies.html">1977-public-private-dependencies</a></li><li><a href="1983-nursery-deprecation.html">1983-nursery-deprecation</a></li><li><a href="1985-tiered-browser-support.html">1985-tiered-browser-support</a></li><li><a href="1990-external-doc-attribute.html">1990-external-doc-attribute</a></li><li><a href="2000-const-generics.html">2000-const-generics</a></li><li><a href="2005-match-ergonomics.html">2005-match-ergonomics</a></li><li><a href="2008-non-exhaustive.html">2008-non-exhaustive</a></li><li><a href="2011-generic-assert.html">2011-generic-assert</a></li><li><a href="2025-nested-method-calls.html">2025-nested-method-calls</a></li><li><a href="2027-object_safe_for_dispatch.html">2027-object_safe_for_dispatch</a></li><li><a href="2033-experimental-coroutines.html">2033-experimental-coroutines</a></li><li><a href="2043-is-aligned-intrinsic.html">2043-is-aligned-intrinsic</a></li><li><a href="2044-license-rfcs.html">2044-license-rfcs</a></li><li><a href="2045-target-feature.html">2045-target-feature</a></li><li><a href="2046-label-break-value.html">2046-label-break-value</a></li><li><a href="2052-epochs.html">2052-epochs</a></li><li><a href="2056-allow-trivial-where-clause-constraints.html">2056-allow-trivial-where-clause-constraints</a></li><li><a href="2057-refcell-replace.html">2057-refcell-replace</a></li><li><a href="2070-panic-implementation.html">2070-panic-implementation</a></li><li><a href="2071-impl-trait-existential-types.html">2071-impl-trait-existential-types</a></li><li><a href="2071-impl-trait-type-alias.html">2071-impl-trait-type-alias</a></li><li><a href="2086-allow-if-let-irrefutables.html">2086-allow-if-let-irrefutables</a></li><li><a href="2089-implied-bounds.html">2089-implied-bounds</a></li><li><a href="2091-inline-semantic.html">2091-inline-semantic</a></li><li><a href="2093-infer-outlives.html">2093-infer-outlives</a></li><li><a href="2094-nll.html">2094-nll</a></li><li><a href="2102-unnamed-fields.html">2102-unnamed-fields</a></li><li><a href="2103-tool-attributes.html">2103-tool-attributes</a></li><li><a href="2113-dyn-trait-syntax.html">2113-dyn-trait-syntax</a></li><li><a href="2115-argument-lifetimes.html">2115-argument-lifetimes</a></li><li><a href="2116-alloc-me-maybe.html">2116-alloc-me-maybe</a></li><li><a href="2124-option-filter.html">2124-option-filter</a></li><li><a href="2126-path-clarity.html">2126-path-clarity</a></li><li><a href="2128-use-nested-groups.html">2128-use-nested-groups</a></li><li><a href="2132-copy-closures.html">2132-copy-closures</a></li><li><a href="2133-all-the-clones.html">2133-all-the-clones</a></li><li><a href="2136-build-systems.html">2136-build-systems</a></li><li><a href="2137-variadic.html">2137-variadic</a></li><li><a href="2141-alternative-registries.html">2141-alternative-registries</a></li><li><a href="2145-type-privacy.html">2145-type-privacy</a></li><li><a href="2151-raw-identifiers.html">2151-raw-identifiers</a></li><li><a href="2166-impl-only-use.html">2166-impl-only-use</a></li><li><a href="2169-euclidean-modulo.html">2169-euclidean-modulo</a></li><li><a href="2175-if-while-or-patterns.html">2175-if-while-or-patterns</a></li><li><a href="2195-really-tagged-unions.html">2195-really-tagged-unions</a></li><li><a href="2196-metabuild.html">2196-metabuild</a></li><li><a href="2203-const-repeat-expr.html">2203-const-repeat-expr</a></li><li><a href="2226-fmt-debug-hex.html">2226-fmt-debug-hex</a></li><li><a href="2229-capture-disjoint-fields.html">2229-capture-disjoint-fields</a></li><li><a href="2230-bury-description.html">2230-bury-description</a></li><li><a href="2235-libc-struct-traits.html">2235-libc-struct-traits</a></li><li><a href="2250-finalize-impl-dyn-syntax.html">2250-finalize-impl-dyn-syntax</a></li><li><a href="2282-profile-dependencies.html">2282-profile-dependencies</a></li><li><a href="2289-associated-type-bounds.html">2289-associated-type-bounds</a></li><li><a href="2294-if-let-guard.html">2294-if-let-guard</a></li><li><a href="2295-os-str-pattern.html">2295-os-str-pattern</a></li><li><a href="2296-option-replace.html">2296-option-replace</a></li><li><a href="2298-macro-at-most-once-rep.html">2298-macro-at-most-once-rep</a></li><li><a href="2300-self-in-typedefs.html">2300-self-in-typedefs</a></li><li><a href="2302-tuple-struct-self-ctor.html">2302-tuple-struct-self-ctor</a></li><li><a href="2306-convert-id.html">2306-convert-id</a></li><li><a href="2307-concrete-nonzero-types.html">2307-concrete-nonzero-types</a></li><li><a href="2314-roadmap-2018.html">2314-roadmap-2018</a></li><li><a href="2318-custom-test-frameworks.html">2318-custom-test-frameworks</a></li><li><a href="2325-stable-simd.html">2325-stable-simd</a></li><li><a href="2333-prior-art.html">2333-prior-art</a></li><li><a href="2338-type-alias-enum-variants.html">2338-type-alias-enum-variants</a></li><li><a href="2341-const-locals.html">2341-const-locals</a></li><li><a href="2342-const-control-flow.html">2342-const-control-flow</a></li><li><a href="2344-const-looping.html">2344-const-looping</a></li><li><a href="2345-const-panic.html">2345-const-panic</a></li><li><a href="2349-pin.html">2349-pin</a></li><li><a href="2351-is-sorted.html">2351-is-sorted</a></li><li><a href="2359-subslice-pattern-syntax.html">2359-subslice-pattern-syntax</a></li><li><a href="2360-bench-black-box.html">2360-bench-black-box</a></li><li><a href="2361-dbg-macro.html">2361-dbg-macro</a></li><li><a href="2363-arbitrary-enum-discriminant.html">2363-arbitrary-enum-discriminant</a></li><li><a href="2383-lint-reasons.html">2383-lint-reasons</a></li><li><a href="2386-used.html">2386-used</a></li><li><a href="2388-try-expr.html">2388-try-expr</a></li><li><a href="2394-async_await.html">2394-async_await</a></li><li><a href="2397-do-not-recommend.html">2397-do-not-recommend</a></li><li><a href="2412-optimize-attr.html">2412-optimize-attr</a></li><li><a href="2420-unreserve-proc.html">2420-unreserve-proc</a></li><li><a href="2421-unreservations-2018.html">2421-unreservations-2018</a></li><li><a href="2436-style-guide.html">2436-style-guide</a></li><li><a href="2437-rustfmt-stability.html">2437-rustfmt-stability</a></li><li><a href="2438-deny-integer-literal-overflow-lint.html">2438-deny-integer-literal-overflow-lint</a></li><li><a href="2451-re-rebalancing-coherence.html">2451-re-rebalancing-coherence</a></li><li><a href="2457-non-ascii-idents.html">2457-non-ascii-idents</a></li><li><a href="2471-lint-test-inner-function.html">2471-lint-test-inner-function</a></li><li><a href="2476-clippy-uno.html">2476-clippy-uno</a></li><li><a href="2480-liballoc.html">2480-liballoc</a></li><li><a href="2495-min-rust-version.html">2495-min-rust-version</a></li><li><a href="2497-if-let-chains.html">2497-if-let-chains</a></li><li><a href="2500-needle.html">2500-needle</a></li><li><a href="2504-fix-error.html">2504-fix-error</a></li><li><a href="2514-union-initialization-and-drop.html">2514-union-initialization-and-drop</a></li><li><a href="2515-type_alias_impl_trait.html">2515-type_alias_impl_trait</a></li><li><a href="2521-c_void-reunification.html">2521-c_void-reunification</a></li><li><a href="2523-cfg-path-version.html">2523-cfg-path-version</a></li><li><a href="2526-const-wildcard.html">2526-const-wildcard</a></li><li><a href="2532-associated-type-defaults.html">2532-associated-type-defaults</a></li><li><a href="2535-or-patterns.html">2535-or-patterns</a></li><li><a href="2539-cfg_attr-multiple-attrs.html">2539-cfg_attr-multiple-attrs</a></li><li><a href="2561-future-possibilities.html">2561-future-possibilities</a></li><li><a href="2565-formal-function-parameter-attributes.html">2565-formal-function-parameter-attributes</a></li><li><a href="2570-linked-list-cursors.html">2570-linked-list-cursors</a></li><li><a href="2574-simd-ffi.html">2574-simd-ffi</a></li><li><a href="2582-raw-reference-mir-operator.html">2582-raw-reference-mir-operator</a></li><li><a href="2591-exhaustive-integer-pattern-matching.html">2591-exhaustive-integer-pattern-matching</a></li><li><a href="2592-futures.html">2592-futures</a></li><li><a href="2603-symbol-name-mangling-v2.html">2603-symbol-name-mangling-v2</a></li><li><a href="2627-raw-dylib-kind.html">2627-raw-dylib-kind</a></li><li><a href="2645-transparent-unions.html">2645-transparent-unions</a></li><li><a href="2657-roadmap-2019.html">2657-roadmap-2019</a></li><li><a href="2678-named-custom-cargo-profiles.html">2678-named-custom-cargo-profiles</a></li><li><a href="2689-compiler-team-contributors.html">2689-compiler-team-contributors</a></li><li><a href="2696-debug-map-key-value.html">2696-debug-map-key-value</a></li><li><a href="2700-associated-constants-on-ints.html">2700-associated-constants-on-ints</a></li><li><a href="2707-dotdot-patterns.html">2707-dotdot-patterns</a></li><li><a href="2795-format-args-implicit-identifiers.html">2795-format-args-implicit-identifiers</a></li><li><a href="2797-project-ffi-unwind.html">2797-project-ffi-unwind</a></li><li><a href="2835-project-safe-transmute.html">2835-project-safe-transmute</a></li><li><a href="2837-demote-apple-32bit.html">2837-demote-apple-32bit</a></li></ol>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">The Rust RFC Book</h1> 

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <ul>
<li>Feature Name: pub_restricted</li>
<li>Start Date: 2015-12-18</li>
<li>RFC PR: <a href="https://github.com/rust-lang/rfcs/pull/1422">rust-lang/rfcs#1422</a></li>
<li>Rust Issue: <a href="https://github.com/rust-lang/rust/issues/32409">rust-lang/rust#32409</a></li>
</ul>
<a class="header" href="#summary" id="summary"><h1>Summary</h1></a>
<p>Expand the current <code>pub</code>/non-<code>pub</code> categorization of items with the
ability to say &quot;make this item visible <em>solely</em> to a (named) module
tree.&quot;</p>
<p>The current <code>crate</code> is one such tree, and would be expressed via:
<code>pub(crate) item</code>. Other trees can be denoted via a path employed in a
<code>use</code> statement, e.g. <code>pub(a::b) item</code>, or <code>pub(super) item</code>.</p>
<a class="header" href="#motivation" id="motivation"><h1>Motivation</h1></a>
<p>Right now, if you have a definition for an item <code>X</code> that you want to
use in many places in a module tree, you can either
(1.) define <code>X</code> at the root of the tree as a non-<code>pub</code> item, or
(2.) you can define <code>X</code> as a <code>pub</code> item in some submodule
(and import into the root of the module tree via <code>use</code>).</p>
<p>But: Sometimes neither of these options is really what you want.</p>
<p>There are scenarios where developers would like an item to be visible
to a particular module subtree (or a whole crate in its entirety), but
it is not possible to move the item's (non-pub) definition to the root
of that subtree (which would be the usual way to expose an item to a
subtree without making it pub).</p>
<p>If the definition of <code>X</code> itself needs access to other private items
within a submodule of the tree, then <code>X</code> <em>cannot</em> be put at the root
of the module tree. Illustration:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
// Intent: `a` exports `I`, `bar`, and `foo`, but nothing else.
pub mod a {
    pub const I: i32 = 3;

    // `semisecret` will be used &quot;many&quot; places within `a`, but
    // is not meant to be exposed outside of `a`.
    fn semisecret(x: i32) -&gt; i32  { use self::b::c::J; x + J }

    pub fn bar(z: i32) -&gt; i32 { semisecret(I) * z }
    pub fn foo(y: i32) -&gt; i32 { semisecret(I) + y }

    mod b {
        mod c {
            const J: i32 = 4; // J is meant to be hidden from the outside world.
        }
    }
}
#}</code></pre></pre>
<p>(Note: the <code>pub mod a</code> is meant to be at the root of some crate.)</p>
<p>The latter code fails to compile, due to the privacy violation where
the body of <code>fn semisecret</code> attempts to access <code>a::b::c::J</code>, which
is not visible in the context of <code>a</code>.</p>
<p>A standard way to deal with this today is to use the second approach
described above (labelled &quot;(2.)&quot;): move <code>fn semisecret</code> down into the place where it can
access <code>J</code>, marking <code>fn semisecret</code> as <code>pub</code> so that it can still be
accessed within the items of <code>a</code>, and then re-exporting <code>semisecret</code>
as necessary up the module tree.</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
// Intent: `a` exports `I`, `bar`, and `foo`, but nothing else.
pub mod a {
    pub const I: i32 = 3;

    // `semisecret` will be used &quot;many&quot; places within `a`, but
    // is not meant to be exposed outside of `a`.
    // (If we put `pub use` here, then *anyone* could access it.)
    use self::b::semisecret;

    pub fn bar(z: i32) -&gt; i32 { semisecret(I) * z }
    pub fn foo(y: i32) -&gt; i32 { semisecret(I) + y }

    mod b {
        pub use self::c::semisecret;
        mod c {
            const J: i32 = 4; // J is meant to be hidden from the outside world.
            pub fn semisecret(x: i32) -&gt; i32  { x + J }
        }
    }
}
#}</code></pre></pre>
<p>This works, but there is a serious issue with it: One cannot easily
tell exactly how &quot;public&quot; <code>fn semisecret</code> is. In particular,
understanding who can access <code>semisecret</code> requires reasoning about
(1.) all of the <code>pub use</code>'s (aka re-exports) of <code>semisecret</code>, and
(2.) the <code>pub</code>-ness of every module in a path leading to <code>fn semisecret</code> or one of its re-exports.</p>
<p>This RFC seeks to remedy the above problem via two main changes.</p>
<ol>
<li>
<p>Give the user a way to explicitly restrict the intended scope
of where a <code>pub</code>-licized item can be used.</p>
</li>
<li>
<p>Modify the privacy rules so that <code>pub</code>-restricted items cannot be
used nor re-exported outside of their respective restricted areas.</p>
</li>
</ol>
<a class="header" href="#impact" id="impact"><h2>Impact</h2></a>
<p>This difficulty in reasoning about the &quot;publicness&quot; of a name is not
just a problem for users; it also complicates efforts within the
compiler to verify that a surface API for a type does not itself use
or expose any private names.</p>
<p>[There][18241] are [a][28325] number [of][28450] bugs [filed][28514] against
[privacy][29668] checking; some are simply
implementation issues, but the comment threads in the issues make it
clear that in some cases, different people have very different mental
models about how privacy interacts with aliases (e.g. <code>type</code>
declarations) and re-exports.</p>
<p>In theory, we can add the changes of this RFC without breaking any old
code. (That is, in principle the only affected code is that for item
definitions that use <code>pub(restriction)</code>. This limited addition would
still provide value to users in their reasoning about the visibility
of such items.)</p>
<p>In practice, I expect that as part of the implementation of this RFC,
we will probably fix pre-existing bugs in the parts of privacy
checking verifying that surface API's do not use or expose private
names.</p>
<p>Important: No such fixes to such pre-existing bugs are being
concretely proposed by this RFC; I am merely musing that by adding a
more expressive privacy system, we will open the door to fix bugs
whose exploits, under the old system, were the only way to express
certain patterns of interest to developers.</p>
<!-- Trait re-exports fail due to privacy of containing module -->
[18241]: https://github.com/rust-lang/rust/issues/18241
<!-- Rules governing references to private types in public APIs not enforced in impls -->
[28325]: https://github.com/rust-lang/rust/issues/28325
<!-- Type alias can be used to bypass privacy check -->
[28450]: https://github.com/rust-lang/rust/issues/28450
<!-- Private trait's methods reachable through a public supertrait -->
[28514]: https://github.com/rust-lang/rust/issues/28514
<!-- Non-exported type in exported type signature does not error -->
[29668]: https://github.com/rust-lang/rust/issues/29668
<!-- Ban private items in public APIs -->
[RFC 136]: https://github.com/rust-lang/rfcs/blob/master/text/0136-no-privates-in-public.md
<!-- The original definition of public items was based on reachability rather than simply checking whether the item is declared pub or not. The RFC also did not describe how privacy and impl definitions are related. -->
[RFC amendment 200]: https://github.com/rust-lang/rfcs/pull/200
<a class="header" href="#detailed-design" id="detailed-design"><h1>Detailed design</h1></a>
<p>The main problem identified in the <a href="#motivation">motivation</a> section is this:</p>
<p>From an module-internal definition like</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
pub mod a { [...] mod b { [...] pub fn semisecret(x: i32) -&gt; i32  { x + J } [...] } }
#}</code></pre></pre>
<p>one cannot readily tell exactly how &quot;public&quot; the <code>fn semisecret</code> is meant to be.</p>
<p>As already stated, this RFC seeks to remedy the above problem via two
main changes.</p>
<ol>
<li>
<p>Give the user a way to explicitly restrict the intended scope
of where a <code>pub</code>-licized item can be used.</p>
</li>
<li>
<p>Modify the privacy rules so that <code>pub</code>-restricted items cannot be
used nor re-exported outside of their respective restricted areas.</p>
</li>
</ol>
<a class="header" href="#syntax" id="syntax"><h2>Syntax</h2></a>
<p>The new feature is to restrict the scope by adding the module subtree
(which acts as the restricted area) in parentheses after the <code>pub</code>
keyword, like so:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
pub(a::b::c) item;
#}</code></pre></pre>
<p>The path in the restriction is resolved just like a <code>use</code> statement: it
is resolved absolutely, from the crate root.</p>
<p>Just like <code>use</code> statements, one can also write relative paths, by
starting them with <code>self</code> or a sequence of <code>super</code>'s.</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
pub(super::super) item;
// or
pub(self) item; // (semantically equiv to no `pub`; see below)
#}</code></pre></pre>
<p>In addition to the forms analogous to <code>use</code>, there is one new form:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
pub(crate) item;
#}</code></pre></pre>
<p>In other words, the grammar is changed like so:</p>
<p>old:</p>
<pre><code>VISIBILITY ::= &lt;empty&gt; | `pub`
</code></pre>
<p>new:</p>
<pre><code>VISIBILITY ::= &lt;empty&gt; | `pub` | `pub` `(` USE_PATH `)` | `pub` `(` `crate` `)`
</code></pre>
<p>One can use these <code>pub(restriction)</code> forms anywhere that one can
currently use <code>pub</code>. In particular, one can use them on item
definitions, methods in an impl, the fields of a struct
definition, and on <code>pub use</code> re-exports.</p>
<a class="header" href="#semantics" id="semantics"><h2>Semantics</h2></a>
<p>The meaning of <code>pub(restriction)</code> is as follows: The definition of
every item, method, field, or name (e.g. a re-export) is associated
with a restriction.</p>
<p>A restriction is either: the universe of all crates (aka
&quot;unrestricted&quot;), the current crate, or an absolute path to a module
sub-hierarchy in the current crate. A restricted thing cannot be
directly &quot;used&quot; in source code outside of its restricted area.  (The
term &quot;used&quot; here is meant to cover both direct reference in the
source, and also implicit reference as the inferred type of an
expression or pattern.)</p>
<ul>
<li>
<p><code>pub</code> written with no explicit restriction means that there is no
restriction, or in other words, the restriction is the universe of
all crates.</p>
</li>
<li>
<p><code>pub(crate)</code> means that the restriction is the current crate.</p>
</li>
<li>
<p><code>pub(&lt;path&gt;)</code> means that the restriction is the module
sub-hierarchy denoted by <code>&lt;path&gt;</code>, resolved in the context of the
occurrence of the <code>pub</code> modifier. (This is to ensure that <code>super</code>
and <code>self</code> make sense in such paths.)</p>
</li>
</ul>
<p>As noted above, the definition means that <code>pub(self) item</code> is the same
as if one had written just <code>item</code>.</p>
<ul>
<li>The main reason to support this level of generality (which is
otherwise just &quot;redundant syntax&quot;) is macros: one can write a macro
that expands to <code>pub($arg) item</code>, and a macro client can pass in
<code>self</code> as the <code>$arg</code> to get the effect of a non-pub definition.</li>
</ul>
<p>NOTE: even if the restriction of an item or name indicates that it is
accessible in some context, it may still be impossible to reference
it. In particular, we will still keep our existing rules regarding
<code>pub</code> items defined in non-<code>pub</code> modules; such items would have no
restriction, but still may be inaccessible if they are not re-exported in
some manner.</p>
<a class="header" href="#revised-example" id="revised-example"><h2>Revised Example</h2></a>
<p>In the running example, one could instead write:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
// Intent: `a` exports `I`, `bar`, and `foo`, but nothing else.
pub mod a {
    pub const I: i32 = 3;

    // `semisecret` will be used &quot;many&quot; places within `a`, but
    // is not meant to be exposed outside of `a`.
    // (`pub use` would be *rejected*; see Note 1 below)
    use self::b::semisecret;

    pub fn bar(z: i32) -&gt; i32 { semisecret(I) * z }
    pub fn foo(y: i32) -&gt; i32 { semisecret(I) + y }

    mod b {
        pub(a) use self::c::semisecret;
        mod c {
            const J: i32 = 4; // J is meant to be hidden from the outside world.

            // `pub(a)` means &quot;usable within hierarchy of `mod a`, but not
            // elsewhere.&quot;
            pub(a) fn semisecret(x: i32) -&gt; i32  { x + J }
        }
    }
}
#}</code></pre></pre>
<p>Note 1: The compiler would reject the variation of the above written
as:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
pub mod a { [...] pub use self::b::semisecret; [...] }
#}</code></pre></pre>
<p>because <code>pub(a) fn semisecret</code> says that it cannot be used outside of
<code>a</code>, and therefore it be incorrect (or at least useless) to reexport
<code>semisecret</code> outside of <code>a</code>.</p>
<p>Note 2: The most direct interpretation of the rules here leads me to
conclude that <code>b</code>'s re-export of <code>semisecret</code> needs to be restricted
to <code>a</code> as well. However, it may be possible to loosen things so that
the re-export could just stay as <code>pub</code> with no extra restriction; see
discussion of &quot;IRS:PUNPM&quot; in Unresolved Questions.</p>
<p>This richer notion of privacy does offer us some other ways to
re-write the running example; instead of defining <code>fn semisecret</code>
within <code>c</code> so that it can access <code>J</code>, we might instead expose <code>J</code> to
<code>mod b</code> and then put <code>fn semisecret</code>, like so:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
pub mod a {
    [...]
    mod b {
        use self::c::J;
        pub(a) fn semisecret(x: i32) -&gt; i32  { x + J }
        mod c {
            pub(b) const J: i32 = 4;
        }
    }
}
#}</code></pre></pre>
<p>(This RFC takes no position on which of the above two structures is
&quot;better&quot;; a toy example like this does not provide enough context to
judge.)</p>
<a class="header" href="#restrictions" id="restrictions"><h2>Restrictions</h2></a>
<p>Lets discuss what the restrictions actually mean.</p>
<p>Some basic definitions: An item is just as it is declared in the Rust
reference manual: a component of a crate, located at a fixed path
(potentially at the &quot;outermost&quot; anonymous module) within the module
tree of the crate.</p>
<p>Every item can be thought of as having some hidden implementation
component(s) along with an exposed surface API.</p>
<p>So, for example, in <code>pub fn foo(x: Input) -&gt; Output { Body }</code>, the
surface of <code>foo</code> includes <code>Input</code> and <code>Output</code>, while the <code>Body</code> is
hidden.</p>
<p>The pre-existing privacy rules (both prior to and after this RFC) try
to enforce two things: (1.) when a item references a path, all of the
names on that path need to be visible (in terms of privacy) in the
referencing context and, (2.) private items should not be exposed in
the surface of public API's.</p>
<ul>
<li>I am using the term &quot;surface&quot; rather than &quot;signature&quot; deliberately,
since I think the term &quot;signature&quot; is too broad to be used to
accurately describe the current semantics of rustc. See my recent
<a href="http://blog.pnkfx.org/blog/2015/12/19/signatures-and-surfaces-thoughts-on-privacy-versus-dependency/">Surface blog post</a> for further discussion.</li>
</ul>
<p>This RFC is expanding the scope of (2.) above, so that the rules are now:</p>
<ol>
<li>
<p>when a item references a path (in its implementation or in its
signature), all of the names on that path must be visible in the
referencing context.</p>
</li>
<li>
<p>items <em>restricted</em> to an area R should not be exposed in the
surface API of names or items that can themselves be exported
beyond R. (Privacy is now a special case of this more general
notion.)</p>
<p>For convenience, it is legal to declare a field (or inherent
method) with a strictly larger area of restriction than its
<code>self</code>. See discussion in the <a href="#fields-and-inherent-methods-more-public-than-self">examples</a>.</p>
</li>
</ol>
<p>In principle, validating (1.) can be done via the pre-existing privacy
code. (However, it may make sense to do it by mapping each name to its
associated restriction; I don't think that will change the outcome,
but it might make the checking code simpler. But I am not an expert on
the current state of the privacy checking code.)</p>
<p>Validating (2.) requires traversing the surface API for each item and
comparing the restriction for every reference to the restriction of
the item itself.</p>
<a class="header" href="#trait-methods" id="trait-methods"><h2>Trait methods</h2></a>
<p>Currently, trait associated item syntax carries no <code>pub</code> modifier.</p>
<p>A question arises when trying to apply the terminology of this RFC:
are trait associated items implicitly <code>pub</code>, in the sense that they
are unrestricted?</p>
<p>The simple answer is: No, associated items are not implicitly <code>pub</code>;
at least, not in general. (They are not in general implicitly <code>pub</code>
today either, as discussed in <a href="https://github.com/rust-lang/rfcs/blob/master/text/0136-no-privates-in-public.md#when-is-an-item-public">RFC 136</a>.)
(If they were implictly <code>pub</code>, things would be difficult; further
discussion in attached <a href="#associated-items-digression">appendix</a>.)</p>
<p>However, since this RFC is introducing multiple kinds of <code>pub</code>, we
should address the topic of what <em>is</em> the <code>pub</code>-ness of associated
items.</p>
<ul>
<li>
<p>When analyzing a trait definition, then associated items should be
considered to inherit the <code>pub</code>-ness, if any, of their defining
trait.</p>
<p>We want to make sure that this code continues to work:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
mod a {
    struct S(String);
    trait Trait {
        fn make_s(&amp;self) -&gt; S; // referencing `S` is ok, b/c `Trait` is not `pub`
    }
}
#}</code></pre></pre>
<p>And under this RFC, we now allow this as well:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
mod a {
    struct S(String);
    mod b {
        pub(a) trait Trait {
            fn mk_s(&amp;self) -&gt; ::a::S;
            // referencing `::a::S` is ok, b/c `Trait` is restricted to `::a`
        }
    }
    use self::b::Trait;
}
#}</code></pre></pre>
<p>Note that in stable Rust today, it is an error to declare the latter trait
within <code>mod b</code> as non-<code>pub</code> (since the <code>use self::b::Trait</code> would be
referencing a private item),
<em>and</em> in the Rust nightly channel it is a warning to declare it
as <code>pub trait Trait { ... }</code>.</p>
<p>The point of this RFC is to give users a sensible way to declare
such traits within <code>b</code>, without allowing them to be exposed outside
of <code>a</code>.</p>
</li>
<li>
<p>When analyzing an <code>impl Trait for Type</code>, there may be distinct
restrictions assigned to the <code>Trait</code> and the <code>Type</code>. However,
since both the <code>Trait</code> and the <code>Type</code> must be visible in the
context of the module where the <code>impl</code> occurs, there should
be a subtree relationship between the two restrictions; in other
words, one restriction should be less than (or equal to) the other.</p>
<p>So just use the minimum of the two restrictions when analyzing
the right-hand sides of the associated items in the impl.</p>
<p>Note: I am largely adopting this rule in an attempt to be
consistent with <a href="https://github.com/rust-lang/rfcs/blob/master/text/0136-no-privates-in-public.md#when-is-an-item-public">RFC 136</a>. I invite
discussion of whether this rule actually makes sense as phrased
here.</p>
</li>
</ul>
<a class="header" href="#more-examples" id="more-examples"><h2>More examples!</h2></a>
<p>These examples meant to explore the syntax a bit. They are <em>not</em> meant
to provide motivation for the feature (i.e. I am not claiming that the
feature is making this code cleaner or easier to reason about).</p>
<a class="header" href="#impl-item-example" id="impl-item-example"><h3>Impl item example</h3></a>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
pub struct S(i32);

mod a {
    pub fn call_foo(s: &amp;super::S) { s.foo(); }

    mod b {
        fn some_method_private_to_b() {
            println!(&quot;inside some_method_private_to_b&quot;);
        }

        impl super::super::S {
            pub(a) fn foo(&amp;self) {
                some_method_private_to_b();
                println!(&quot;only callable within `a`: {}&quot;, self.0);
            }
        }
    }
}

fn rejected(s: &amp;S) {
    s.foo(); //~ ERROR: `S::foo` not visible outside of module `a`
}
#}</code></pre></pre>
<p>(You may be wondering: &quot;Could we move that <code>impl S</code> out to the
top-level, out of <code>mod a</code>?&quot; Well ... see discussion in the
<a href="#can-definition-site-fall-outside-restriction">unresolved questions</a>.)</p>
<a class="header" href="#restricting-fields-example" id="restricting-fields-example"><h3>Restricting fields example</h3></a>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
mod a {
    #[derive(Default)]
    struct Priv(i32);

    pub mod b {
        use a::Priv as Priv_a;

        #[derive(Default)]
        pub struct F {
            pub    x: i32,
                   y: Priv_a,
            pub(a) z: Priv_a,
        }

        #[derive(Default)]
        pub struct G(pub i32, Priv_a, pub(a) Priv_a);

        // ... accesses to F.{x,y,z} ...
        // ... accesses to G.{0,1,2} ...
    }
    // ... accesses to F.{x,z} ...
    // ... accesses to G.{0,2} ...
}

mod k {
    use a::b::{F, G};
    // ... accesses to F and F.x ...
    // ... accesses to G and G.0 ...
}
#}</code></pre></pre>
<a class="header" href="#fields-and-inherent-methods-more-public-than-self" id="fields-and-inherent-methods-more-public-than-self"><h3>Fields and inherent methods more public than self</h3></a>
<p>In Rust today, one can write</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
mod a { struct X { pub y: i32, } }
#}</code></pre></pre>
<p>This RFC was crafted to say that fields and inherent methods
can have an associated restriction that is larger than the restriction
of its <code>self</code>. This was both to keep from breaking the above
code, and also because it would be annoying to be forced to write:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
mod a { struct X { pub(a) y: i32, } }
#}</code></pre></pre>
<p>(This RFC is not an attempt to resolve things like
<a href="https://github.com/rust-lang/rust/issues/30079">Rust Issue 30079</a>; the decision of how to handle that issue
can be dealt with orthogonally, in my opinion.)</p>
<p>So, under this RFC, the following is legal:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
mod a {
    pub use self::b::stuff_with_x;
    mod b {
        struct X { pub y: i32, pub(a) z: i32 }
        mod c {
            impl super::X {
                pub(c) fn only_in_c(&amp;mut self) { self.y += 1; }

                pub fn callanywhere(&amp;mut self) {
                    self.only_in_c();
                    println!(&quot;X.y is now: {}&quot;, self.y);
                }
            }
        }
        pub fn stuff_with_x() {
            let mut x = X { y: 10, z: 20};
            x.callanywhere();
        }
    }
}
#}</code></pre></pre>
<p>In particular:</p>
<ul>
<li>
<p>It is okay that the fields <code>y</code> and <code>z</code> and the inherent method
<code>fn callanywhere</code> are more publicly visible than <code>X</code>.</p>
<p>(Just because we declare something <code>pub</code> does not mean it will
actually be <em>possible</em> to reach it from arbitrary contexts. Whether
or not such access is possible will depend on many things, including
but not limited to the restriction attached and also future decisions
about issues like <a href="https://github.com/rust-lang/rust/issues/30079">issue 30079</a>.)</p>
</li>
<li>
<p>We are allowed to restrict an inherent method, <code>fn only_in_c</code>, to
a subtree of the module tree where <code>X</code> is itself visible.</p>
</li>
</ul>
<a class="header" href="#re-exports" id="re-exports"><h3>Re-exports</h3></a>
<p>Here is an example of a <code>pub use</code> re-export using the new
feature, including both correct and invalid uses of the extended form.</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
mod a {
    mod b {
        pub(a) struct X { pub y: i32, pub(a) z: i32 } // restricted to `mod a` tree
        mod c {
            pub mod d {
                pub(super) use a::b::X as P; // ok: a::b::c is submodule of `a`
            }

            fn swap_ok(x: d::P) -&gt; d::P { // ok: `P` accessible here
                X { z: x.y, y: x.z }
            }
        }

        fn swap_bad(x: c::d::P) -&gt; c::d::P { //~ ERROR: `c::d::P` not visible outside `a::b::c`
            X { z: x.y, y: x.z }
        }

        mod bad {
            pub use super::X; //~ ERROR: `X` cannot be reexported outside of `a`
        }
    }

    fn swap_ok2(x: X) -&gt; X { // ok: `X` accessible from `mod a`.
        X { z: x.y, y: x.z }
    }
}
#}</code></pre></pre>
<a class="header" href="#crate-restricted-visibility" id="crate-restricted-visibility"><h3>Crate restricted visibility</h3></a>
<p>This is a concrete illusration of how one might use the <code>pub(crate) item</code> form,
(which is perhaps quite similar to Java's default &quot;package visibility&quot;).</p>
<p>Crate <code>c1</code>:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
pub mod a {
    struct Priv(i32);

    pub(crate) struct R { pub y: i32, z: Priv } // ok: field allowed to be more public
    pub        struct S { pub y: i32, z: Priv }

    pub fn to_r_bad(s: S) -&gt; R { ... } //~ ERROR: `R` restricted solely to this crate

    pub(crate) fn to_r(s: S) -&gt; R { R { y: s.y, z: s.z } } // ok: restricted to crate
}

use a::{R, S}; // ok: `a::R` and `a::S` are both visible

pub use a::R as ReexportAttempt; //~ ERROR: `a::R` restricted solely to this crate
#}</code></pre></pre>
<p>Crate <code>c2</code>:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
extern crate c1;

use c1::a::S; // ok: `S` is unrestricted

use c1::a::R; //~ ERROR: `c1::a::R` not visible outside of its crate
#}</code></pre></pre>
<a class="header" href="#precedent" id="precedent"><h2>Precedent</h2></a>
<p>When I started on this I was not sure if this form of delimited access
to a particular module subtree had a precedent; the closest thing I
could think of was C++ <code>friend</code> modifiers (but <code>friend</code> is far more
ad-hoc and free-form than what is being proposed here).</p>
<a class="header" href="#scala" id="scala"><h3>Scala</h3></a>
<p>It has since been pointed out to me that Scala has scoped access
modifiers <code>protected[Y]</code> and <code>private[Y]</code>, which specify that access
is provided upto <code>Y</code> (where <code>Y</code> can be a package, class or singleton
object).</p>
<p>The feature proposed by this RFC appears to be similar in intent to
Scala's scoped access modifiers.</p>
<p>Having said that, I will admit that I am not clear on what
distinction, if any, Scala draws between <code>protected[Y]</code> and
<code>private[Y]</code> when <code>Y</code> is a package, which is the main analogy for our
purposes, or if they just allow both forms as synonyms for
convenience.</p>
<p>(I can imagine a hypothetical distinction in Scala when <code>Y</code> is a
class, but my skimming online has not provided insight as to what the
actual distinction is.)</p>
<p>Even if there is some distinction drawn between the two forms in
Scala, I suspect Rust does not need an analogous distinction in it's
<code>pub(restricted)</code></p>
<a class="header" href="#drawbacks" id="drawbacks"><h1>Drawbacks</h1></a>
<p>Obviously,
<code>pub(restriction) item</code> complicates the surface syntax of the language.</p>
<ul>
<li>However, my counter-argument to this drawback is that this feature
in fact <em>simplifies</em> the developer's mental model. It is easier to
directly encode the expected visibility of an item via
<code>pub(restriction)</code> than to figure out the right concoction via a
mix of nested <code>mod</code> and <code>pub use</code> statements. And likewise, it is
easier to read it too.</li>
</ul>
<p>Developers may misuse this form and make it hard to access the tasty
innards of other modules.</p>
<ul>
<li>
<p>This is true, but I claim it is irrelevant.</p>
<p>The effect of this change is solely on the visibility of items
<em>within</em> a crate. No rules for inter-crate access change.</p>
<p>From the perspective of cross-crate development, this RFC changes
nothing, except that it may lead some crate authors to make some
things no longer universally <code>pub</code> that they were forced to make
visible before due to earlier limitations. I claim that in such
cases, those crate authors probably always intended for such items
to be non-<code>pub</code>, but language limitations were forcing their hand.</p>
<p>As for intra-crate access: My expectation is that an individual
crate will be made by a team of developers who can work out what
mutual visibility they want and how it should evolve over time.
This feature may affect their work flow to some degree, but they
can choose to either use it or not, based on their own internal
policies.</p>
</li>
</ul>
<a class="header" href="#alternatives" id="alternatives"><h1>Alternatives</h1></a>
<a class="header" href="#do-not-extend-the-language" id="do-not-extend-the-language"><h2>Do not extend the language!</h2></a>
<ul>
<li>
<p>Change privacy rules and make privacy analysis &quot;smarter&quot;
(e.g. global reachabiliy analysis)</p>
<p>The main problem with this approach is that we tried it, and it
did not work well: The implementation was buggy, and the user-visible
error messages were hard to understand.</p>
<p>See discussion when the team was discussing the <a href="https://github.com/rust-lang/meeting-minutes/blob/master/weekly-meetings/2014-09-16.md#rfc-public-items">public items amendment</a></p>
</li>
</ul>
<ul>
<li>
<p>&quot;Fix&quot; the mental model of privacy (if necessary) without extending
the language.</p>
<p>The alternative is bascially saying: &quot;Our existing system is fine; all
of the problems with it are due to bugs in the implementation&quot;</p>
<p>I am sympathetic to this response. However, I think it doesn't
quite hold up. Some users want to be able to define items that are
exposed outside of their module but still restrict the scope of
where they can be referenced, as discussed in the <a href="#motivation">motivation</a>
section, and I do not think the current model can be &quot;fixed&quot; to
support that use case, at least not without adding some sort of
global reachability analysis as discussed in the previous bullet.</p>
</li>
</ul>
<p>In addition, these two alternatives do not address the main point
being made in the <a href="#motivation">motivation</a> section: one cannot tell exactly how
&quot;public&quot; a <code>pub</code> item is, without working backwards through the module
tree for all of its re-exports.</p>
<a class="header" href="#curb-your-ambitions" id="curb-your-ambitions"><h2>Curb your ambitions!</h2></a>
<ul>
<li>
<p>Instead of adding support for restricting to arbitrary module
subtrees, narrow the feature to just <code>pub(crate) item</code>, so that one
chooses either &quot;module private&quot; (by adding no modifier), or
&quot;universally visible&quot; (by adding <code>pub</code>), or &quot;visible to just the
current crate&quot; (by adding <code>pub(crate)</code>).</p>
<p>This would be somewhat analogous to Java's relatively coarse
grained privacy rules, where one can choose <code>public</code>, <code>private</code>,
<code>protected</code>, or the unnamed &quot;package&quot; visibility.</p>
<p>I am all for keeping the implementation simple. However, the reason
that we should support arbitrary module subtrees is that doing so
will enable certain refactorings. Namely, if I decide I want to
inline the definition for one or more crates <code>A1</code>, <code>A2</code>, ... into
client crate <code>C</code> (i.e. replacing <code>extern crate A1;</code> with an
suitably defined <code>mod A1 { ... }</code>, but I do not want to worry about
whether doing so will risk future changes violating abstraction
boundaries that were previously being enforced via <code>pub(crate)</code>,
then I believe allowing <code>pub(path)</code> will allow a mechanical tool to
do the inline refactoring, rewriting each <code>pub(crate)</code> as <code>pub(A1)</code>
as necessary.</p>
</li>
</ul>
<a class="header" href="#be-more-ambitious" id="be-more-ambitious"><h2>Be more ambitious!</h2></a>
<p>This feature could be extended in various ways.</p>
<p>For example:</p>
<ul>
<li>
<p>As mentioned on the RFC comment thread,
we could allow multiple paths in the restriction-specification:
<code>pub(path1, path2, path3)</code>.</p>
<p>This, for better or worse, would start
to look a lot like <code>friend</code> declarations from C++.</p>
</li>
<li>
<p>Also as mentioned on the RFC comment thread, the
<code>pub(restricted)</code> form does not have any variant where the
restrction-specification denotes the whole universe.
In other words, there's no current way to get the same effect
as <code>pub item</code> via <code>pub(restricted) item</code>; you cannot say
<code>pub(universe) item</code> (even though I do so in a tongue-in-cheek
manner elsewhere in this RFC).</p>
<p>Some future syntaxes to support this have been proposed in the
RFC comment thread, such as <code>pub(::)</code>. But this RFC is leaving the
actual choice to add such an extension (and what syntax to use
for it) up to a later amendment in the future.</p>
</li>
</ul>
<a class="header" href="#unresolved-questions" id="unresolved-questions"><h1>Unresolved questions</h1></a>
<a class="header" href="#can-definition-site-fall-outside-restriction" id="can-definition-site-fall-outside-restriction"><h2>Can definition site fall outside restriction?</h2></a>
<p>For example, is it illegal to do the following:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
mod a {
  mod child { }
  mod b { pub(super::child) const J: i32 = 3; }
}
#}</code></pre></pre>
<p>Or does it just mean that <code>J</code>, despite being defined in <code>mod b</code>, is
itself not accessible in <code>mod b</code>?</p>
<p>pnkfelix is personally inclined to make this sort of thing illegal,
mainly because he finds it totally unintuitive, but is interested in
hearing counter-arguments.</p>
<a class="header" href="#implicit-restriction-satisfaction-irspunpm" id="implicit-restriction-satisfaction-irspunpm"><h2>Implicit Restriction Satisfaction (IRS:PUNPM)</h2></a>
<p>If a re-export occurs within a non-<code>pub</code> module, can we treat it as
implicitly satisfying a restriction to <code>super</code> imposed by the item it
is re-exporting?</p>
<p>In particular, the <a href="#revised-example">revised example</a> included:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
// Intent: `a` exports `I` and `foo`, but nothing else.
pub mod a {
    [...]
    mod b {
        pub(a) use self::c::semisecret;
        mod c { pub(a) fn semisecret(x: i32) -&gt; i32  { x + J } }
    }
}
#}</code></pre></pre>
<p>However, since <code>b</code> is non-<code>pub</code>, its <code>pub</code> items and re-exports are
solely accessible via the subhierarchy of its module parent (i.e.,
<code>mod a</code>, as long as no entity attempts to re-export them to a braoder
scope.</p>
<p>In other words, in some sense <code>mod b { pub use item; }</code> <em>could</em>
implicitly satisfy a restriction to <code>super</code> imposed by <code>item</code> (if we
chose to allow it).</p>
<p>Note: If it were <code>pub mod b</code> or <code>pub(restrict) mod b</code>, then the above
reasoning would not hold.  Therefore, this discussion is limited to
re-exports from non-<code>pub</code> modules.</p>
<p>If we do not allow such implicit restriction satisfaction
for <code>pub use</code> re-exports from non-<code>pub</code> modules (IRS:PUNPM), then:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
pub mod a {
    [...]
    mod b {
        pub use self::c::semisecret;
        mod c { pub(a) fn semisecret(x: i32) -&gt; i32  { x + J } }
    }
}
#}</code></pre></pre>
<p>would be rejected, and one would be expected to write either:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
        pub(super) use self::c::semisecret;
#}</code></pre></pre>
<p>or</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
        pub(a) use self::c::semisecret;
#}</code></pre></pre>
<p>(Side note: I am <em>not</em> saying that under IRS:PUNPM, the two forms <code>pub use item</code> and <code>pub(super) use item</code> would be considered synonymous,
even in the context of a non-pub module like <code>mod b</code>. In particular,
<code>pub(super) use item</code> may be imposing a new restriction on the
re-exported name that was not part of its original definition.)</p>
<a class="header" href="#interaction-with-globs" id="interaction-with-globs"><h2>Interaction with Globs</h2></a>
<p>Glob re-exports
currently only re-export <code>pub</code> (as in <code>pub(universe)</code> items).</p>
<p>What should glob-reepxorts do with respect to <code>pub(restricted)</code>?</p>
<p>Here is an illustrating example pointed out by petrochenkov in the
comment thread:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
mod m {
    /*priv*/ pub(m) struct S1;
    pub(super) S2;
    pub(foo::bar) S3;
    pub S4;

    mod n {

        // What is reexported here?
        // Just `S4`?
        // Anything in `m` visible
        //  to `n` (which is not consisent with the current treatment of
        `pub` by globs).

        pub use m::*;
    }
}

// What is reexported here?
pub use m::*;
pub(baz::qux) use m::*;
#}</code></pre></pre>
<p>This remains an unresolved question, but my personal inclination, at
least for the initial implementation, is to make globs only import
purely <code>pub</code> items; no non-<code>pub</code>, and no <code>pub(restricted)</code>.</p>
<p>After we get more experience with <code>pub(restricted)</code> (and perhaps make
other changes that may come in future RFCs), we will be in a better
position to evaluate what to do here.</p>
<a class="header" href="#appendices" id="appendices"><h1>Appendices</h1></a>
<a class="header" href="#associated-items-digression" id="associated-items-digression"><h2>Associated Items Digression</h2></a>
<p>If associated items were implicitly <code>pub</code>, in the sense that they are
unrestricted, then that would conflict with the rules imposed by this
RFC, in the sense that the surface API of a non-<code>pub</code> trait is
composed of its associated items, and so if all associated items were
implicitly <code>pub</code> and unrestricted, then this code would be rejected:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
mod a {
    struct S(String);
    trait Trait {
        fn mk_s(&amp;self) -&gt; S; // is this implicitly `pub` and unrestricted?
    }
    impl Trait for () { fn mk_s(&amp;self) -&gt; S { S(format!(&quot;():()&quot;)) } }
    impl Trait for i32 { fn mk_s(&amp;self) -&gt; S { S(format!(&quot;{}:i32&quot;, self)) } }
    pub fn foo(x:i32) -&gt; String { format!(&quot;silly{}{}&quot;, ().mk_s().0, x.mk_s().0) }
}
#}</code></pre></pre>
<p>If associated items were implicitly <code>pub</code> and unrestricted, then the
above code would be rejected under direct interpretation of the rules
of this RFC (because <code>fn make_s</code> is implicitly unrestricted, but the
surface of <code>fn make_s</code> references <code>S</code>, a non-<code>pub</code> item). This would
be backwards-incompatible (and just darn inconvenient too).</p>
<p>So, to be clear, this RFC is <em>not</em> suggesting that associated items be
implicitly <code>pub</code> and unrestricted.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="1419-slice-copy.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="1432-replace-slice.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="1419-slice-copy.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="1432-replace-slice.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
