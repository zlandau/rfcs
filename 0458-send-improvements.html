<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>0458-send-improvements - The Rust RFC Book</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body class="light">
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { } 
            if (theme === null || theme === undefined) { theme = default_theme; }
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <ol class="chapter"><li class="affix"><a href="introduction.html">Introduction</a></li><li><a href="0001-private-fields.html">0001-private-fields</a></li><li><a href="0002-rfc-process.html">0002-rfc-process</a></li><li><a href="0003-attribute-usage.html">0003-attribute-usage</a></li><li><a href="0008-new-intrinsics.html">0008-new-intrinsics</a></li><li><a href="0016-more-attributes.html">0016-more-attributes</a></li><li><a href="0019-opt-in-builtin-traits.html">0019-opt-in-builtin-traits</a></li><li><a href="0026-remove-priv.html">0026-remove-priv</a></li><li><a href="0034-bounded-type-parameters.html">0034-bounded-type-parameters</a></li><li><a href="0040-libstd-facade.html">0040-libstd-facade</a></li><li><a href="0042-regexps.html">0042-regexps</a></li><li><a href="0048-traits.html">0048-traits</a></li><li><a href="0049-match-arm-attributes.html">0049-match-arm-attributes</a></li><li><a href="0050-assert.html">0050-assert</a></li><li><a href="0059-remove-tilde.html">0059-remove-tilde</a></li><li><a href="0060-rename-strbuf.html">0060-rename-strbuf</a></li><li><a href="0063-module-file-system-hierarchy.html">0063-module-file-system-hierarchy</a></li><li><a href="0066-better-temporary-lifetimes.html">0066-better-temporary-lifetimes</a></li><li><a href="0068-const-unsafe-pointers.html">0068-const-unsafe-pointers</a></li><li><a href="0069-ascii-literals.html">0069-ascii-literals</a></li><li><a href="0071-const-block-expr.html">0071-const-block-expr</a></li><li><a href="0079-undefined-struct-layout.html">0079-undefined-struct-layout</a></li><li><a href="0085-pattern-macros.html">0085-pattern-macros</a></li><li><a href="0086-plugin-registrar.html">0086-plugin-registrar</a></li><li><a href="0087-trait-bounds-with-plus.html">0087-trait-bounds-with-plus</a></li><li><a href="0089-loadable-lints.html">0089-loadable-lints</a></li><li><a href="0090-lexical-syntax-simplification.html">0090-lexical-syntax-simplification</a></li><li><a href="0092-struct-grammar.html">0092-struct-grammar</a></li><li><a href="0093-remove-format-intl.html">0093-remove-format-intl</a></li><li><a href="0100-partial-cmp.html">0100-partial-cmp</a></li><li><a href="0107-pattern-guards-with-bind-by-move.html">0107-pattern-guards-with-bind-by-move</a></li><li><a href="0109-remove-crate-id.html">0109-remove-crate-id</a></li><li><a href="0111-index-traits.html">0111-index-traits</a></li><li><a href="0112-remove-cross-borrowing.html">0112-remove-cross-borrowing</a></li><li><a href="0114-closures.html">0114-closures</a></li><li><a href="0115-rm-integer-fallback.html">0115-rm-integer-fallback</a></li><li><a href="0116-no-module-shadowing.html">0116-no-module-shadowing</a></li><li><a href="0123-share-to-threadsafe.html">0123-share-to-threadsafe</a></li><li><a href="0130-box-not-special.html">0130-box-not-special</a></li><li><a href="0131-target-specification.html">0131-target-specification</a></li><li><a href="0132-ufcs.html">0132-ufcs</a></li><li><a href="0135-where.html">0135-where</a></li><li><a href="0136-no-privates-in-public.html">0136-no-privates-in-public</a></li><li><a href="0139-remove-cross-borrowing-entirely.html">0139-remove-cross-borrowing-entirely</a></li><li><a href="0141-lifetime-elision.html">0141-lifetime-elision</a></li><li><a href="0151-capture-by-value.html">0151-capture-by-value</a></li><li><a href="0155-anonymous-impl-only-in-same-module.html">0155-anonymous-impl-only-in-same-module</a></li><li><a href="0160-if-let.html">0160-if-let</a></li><li><a href="0164-feature-gate-slice-pats.html">0164-feature-gate-slice-pats</a></li><li><a href="0168-mod.html">0168-mod</a></li><li><a href="0169-use-path-as-id.html">0169-use-path-as-id</a></li><li><a href="0179-and-mut-patterns.html">0179-and-mut-patterns</a></li><li><a href="0184-tuple-accessors.html">0184-tuple-accessors</a></li><li><a href="0192-bounds-on-object-and-generic-types.html">0192-bounds-on-object-and-generic-types</a></li><li><a href="0194-cfg-syntax.html">0194-cfg-syntax</a></li><li><a href="0195-associated-items.html">0195-associated-items</a></li><li><a href="0198-slice-notation.html">0198-slice-notation</a></li><li><a href="0199-ownership-variants.html">0199-ownership-variants</a></li><li><a href="0201-error-chaining.html">0201-error-chaining</a></li><li><a href="0202-subslice-syntax-change.html">0202-subslice-syntax-change</a></li><li><a href="0212-restore-int-fallback.html">0212-restore-int-fallback</a></li><li><a href="0213-defaulted-type-params.html">0213-defaulted-type-params</a></li><li><a href="0214-while-let.html">0214-while-let</a></li><li><a href="0216-collection-views.html">0216-collection-views</a></li><li><a href="0218-empty-struct-with-braces.html">0218-empty-struct-with-braces</a></li><li><a href="0221-panic.html">0221-panic</a></li><li><a href="0230-remove-runtime.html">0230-remove-runtime</a></li><li><a href="0231-upvar-capture-inference.html">0231-upvar-capture-inference</a></li><li><a href="0234-variants-namespace.html">0234-variants-namespace</a></li><li><a href="0235-collections-conventions.html">0235-collections-conventions</a></li><li><a href="0236-error-conventions.html">0236-error-conventions</a></li><li><a href="0240-unsafe-api-location.html">0240-unsafe-api-location</a></li><li><a href="0241-deref-conversions.html">0241-deref-conversions</a></li><li><a href="0243-trait-based-exception-handling.html">0243-trait-based-exception-handling</a></li><li><a href="0246-const-vs-static.html">0246-const-vs-static</a></li><li><a href="0255-object-safety.html">0255-object-safety</a></li><li><a href="0256-remove-refcounting-gc-of-t.html">0256-remove-refcounting-gc-of-t</a></li><li><a href="0320-nonzeroing-dynamic-drop.html">0320-nonzeroing-dynamic-drop</a></li><li><a href="0326-restrict-xXX-to-ascii.html">0326-restrict-xXX-to-ascii</a></li><li><a href="0339-statically-sized-literals.html">0339-statically-sized-literals</a></li><li><a href="0341-remove-virtual-structs.html">0341-remove-virtual-structs</a></li><li><a href="0342-keywords.html">0342-keywords</a></li><li><a href="0344-conventions-galore.html">0344-conventions-galore</a></li><li><a href="0356-no-module-prefixes.html">0356-no-module-prefixes</a></li><li><a href="0369-num-reform.html">0369-num-reform</a></li><li><a href="0378-expr-macros.html">0378-expr-macros</a></li><li><a href="0379-remove-reflection.html">0379-remove-reflection</a></li><li><a href="0380-stabilize-std-fmt.html">0380-stabilize-std-fmt</a></li><li><a href="0385-module-system-cleanup.html">0385-module-system-cleanup</a></li><li><a href="0387-higher-ranked-trait-bounds.html">0387-higher-ranked-trait-bounds</a></li><li><a href="0390-enum-namespacing.html">0390-enum-namespacing</a></li><li><a href="0401-coercions.html">0401-coercions</a></li><li><a href="0403-cargo-build-command.html">0403-cargo-build-command</a></li><li><a href="0404-change-prefer-dynamic.html">0404-change-prefer-dynamic</a></li><li><a href="0418-struct-variants.html">0418-struct-variants</a></li><li><a href="0430-finalizing-naming-conventions.html">0430-finalizing-naming-conventions</a></li><li><a href="0438-precedence-of-plus.html">0438-precedence-of-plus</a></li><li><a href="0439-cmp-ops-reform.html">0439-cmp-ops-reform</a></li><li><a href="0445-extension-trait-conventions.html">0445-extension-trait-conventions</a></li><li><a href="0446-es6-unicode-escapes.html">0446-es6-unicode-escapes</a></li><li><a href="0447-no-unused-impl-parameters.html">0447-no-unused-impl-parameters</a></li><li><a href="0450-un-feature-gate-some-more-gates.html">0450-un-feature-gate-some-more-gates</a></li><li><a href="0453-macro-reform.html">0453-macro-reform</a></li><li><a href="0458-send-improvements.html" class="active">0458-send-improvements</a></li><li><a href="0459-disallow-shadowing.html">0459-disallow-shadowing</a></li><li><a href="0461-tls-overhaul.html">0461-tls-overhaul</a></li><li><a href="0463-future-proof-literal-suffixes.html">0463-future-proof-literal-suffixes</a></li><li><a href="0469-feature-gate-box-patterns.html">0469-feature-gate-box-patterns</a></li><li><a href="0474-path-reform.html">0474-path-reform</a></li><li><a href="0486-std-ascii-reform.html">0486-std-ascii-reform</a></li><li><a href="0490-dst-syntax.html">0490-dst-syntax</a></li><li><a href="0494-c_str-and-c_vec-stability.html">0494-c_str-and-c_vec-stability</a></li><li><a href="0495-array-pattern-changes.html">0495-array-pattern-changes</a></li><li><a href="0501-consistent_no_prelude_attributes.html">0501-consistent_no_prelude_attributes</a></li><li><a href="0503-prelude-stabilization.html">0503-prelude-stabilization</a></li><li><a href="0504-show-stabilization.html">0504-show-stabilization</a></li><li><a href="0505-api-comment-conventions.html">0505-api-comment-conventions</a></li><li><a href="0507-release-channels.html">0507-release-channels</a></li><li><a href="0509-collections-reform-part-2.html">0509-collections-reform-part-2</a></li><li><a href="0517-io-os-reform.html">0517-io-os-reform</a></li><li><a href="0520-new-array-repeat-syntax.html">0520-new-array-repeat-syntax</a></li><li><a href="0522-self-impl.html">0522-self-impl</a></li><li><a href="0526-fmt-text-writer.html">0526-fmt-text-writer</a></li><li><a href="0528-string-patterns.html">0528-string-patterns</a></li><li><a href="0529-conversion-traits.html">0529-conversion-traits</a></li><li><a href="0531-define-rfc-scope.html">0531-define-rfc-scope</a></li><li><a href="0532-self-in-use.html">0532-self-in-use</a></li><li><a href="0533-no-array-elem-moves.html">0533-no-array-elem-moves</a></li><li><a href="0534-deriving2derive.html">0534-deriving2derive</a></li><li><a href="0544-rename-int-uint.html">0544-rename-int-uint</a></li><li><a href="0546-Self-not-sized-by-default.html">0546-Self-not-sized-by-default</a></li><li><a href="0550-macro-future-proofing.html">0550-macro-future-proofing</a></li><li><a href="0556-raw-lifetime.html">0556-raw-lifetime</a></li><li><a href="0558-require-parentheses-for-chained-comparisons.html">0558-require-parentheses-for-chained-comparisons</a></li><li><a href="0560-integer-overflow.html">0560-integer-overflow</a></li><li><a href="0563-remove-ndebug.html">0563-remove-ndebug</a></li><li><a href="0565-show-string-guidelines.html">0565-show-string-guidelines</a></li><li><a href="0572-rustc-attribute.html">0572-rustc-attribute</a></li><li><a href="0574-drain-range.html">0574-drain-range</a></li><li><a href="0580-rename-collections.html">0580-rename-collections</a></li><li><a href="0587-fn-return-should-be-an-associated-type.html">0587-fn-return-should-be-an-associated-type</a></li><li><a href="0592-c-str-deref.html">0592-c-str-deref</a></li><li><a href="0593-forbid-Self-definitions.html">0593-forbid-Self-definitions</a></li><li><a href="0599-default-object-bound.html">0599-default-object-bound</a></li><li><a href="0601-replace-be-with-become.html">0601-replace-be-with-become</a></li><li><a href="0639-discriminant-intrinsic.html">0639-discriminant-intrinsic</a></li><li><a href="0640-debug-improvements.html">0640-debug-improvements</a></li><li><a href="0702-rangefull-expression.html">0702-rangefull-expression</a></li><li><a href="0735-allow-inherent-impls-anywhere.html">0735-allow-inherent-impls-anywhere</a></li><li><a href="0736-privacy-respecting-fru.html">0736-privacy-respecting-fru</a></li><li><a href="0738-variance.html">0738-variance</a></li><li><a href="0769-sound-generic-drop.html">0769-sound-generic-drop</a></li><li><a href="0771-std-iter-once.html">0771-std-iter-once</a></li><li><a href="0803-type-ascription.html">0803-type-ascription</a></li><li><a href="0809-box-and-in-for-stdlib.html">0809-box-and-in-for-stdlib</a></li><li><a href="0823-hash-simplification.html">0823-hash-simplification</a></li><li><a href="0832-from-elem-with-love.html">0832-from-elem-with-love</a></li><li><a href="0839-embrace-extend-extinguish.html">0839-embrace-extend-extinguish</a></li><li><a href="0840-no-panic-in-c-string.html">0840-no-panic-in-c-string</a></li><li><a href="0873-type-macros.html">0873-type-macros</a></li><li><a href="0879-small-base-lexing.html">0879-small-base-lexing</a></li><li><a href="0888-compiler-fence-intrinsics.html">0888-compiler-fence-intrinsics</a></li><li><a href="0909-move-thread-local-to-std-thread.html">0909-move-thread-local-to-std-thread</a></li><li><a href="0911-const-fn.html">0911-const-fn</a></li><li><a href="0921-entry_v3.html">0921-entry_v3</a></li><li><a href="0940-hyphens-considered-harmful.html">0940-hyphens-considered-harmful</a></li><li><a href="0953-op-assign.html">0953-op-assign</a></li><li><a href="0968-closure-return-type-syntax.html">0968-closure-return-type-syntax</a></li><li><a href="0979-align-splitn-with-other-languages.html">0979-align-splitn-with-other-languages</a></li><li><a href="0980-read-exact.html">0980-read-exact</a></li><li><a href="0982-dst-coercion.html">0982-dst-coercion</a></li><li><a href="1011-process.exit.html">1011-process.exit</a></li><li><a href="1014-stdout-existential-crisis.html">1014-stdout-existential-crisis</a></li><li><a href="1023-rebalancing-coherence.html">1023-rebalancing-coherence</a></li><li><a href="1030-prelude-additions.html">1030-prelude-additions</a></li><li><a href="1040-duration-reform.html">1040-duration-reform</a></li><li><a href="1044-io-fs-2.1.html">1044-io-fs-2.1</a></li><li><a href="1047-socket-timeouts.html">1047-socket-timeouts</a></li><li><a href="1048-rename-soft-link-to-symlink.html">1048-rename-soft-link-to-symlink</a></li><li><a href="1054-str-words.html">1054-str-words</a></li><li><a href="1057-io-error-sync.html">1057-io-error-sync</a></li><li><a href="1058-slice-tail-redesign.html">1058-slice-tail-redesign</a></li><li><a href="1066-safe-mem-forget.html">1066-safe-mem-forget</a></li><li><a href="1068-rust-governance.html">1068-rust-governance</a></li><li><a href="1096-remove-static-assert.html">1096-remove-static-assert</a></li><li><a href="1102-rename-connect-to-join.html">1102-rename-connect-to-join</a></li><li><a href="1105-api-evolution.html">1105-api-evolution</a></li><li><a href="1119-result-expect.html">1119-result-expect</a></li><li><a href="1122-language-semver.html">1122-language-semver</a></li><li><a href="1123-str-split-at.html">1123-str-split-at</a></li><li><a href="1131-likely-intrinsic.html">1131-likely-intrinsic</a></li><li><a href="1135-raw-pointer-comparisons.html">1135-raw-pointer-comparisons</a></li><li><a href="1152-slice-string-symmetry.html">1152-slice-string-symmetry</a></li><li><a href="1156-adjust-default-object-bounds.html">1156-adjust-default-object-bounds</a></li><li><a href="1174-into-raw-fd-socket-handle-traits.html">1174-into-raw-fd-socket-handle-traits</a></li><li><a href="1183-swap-out-jemalloc.html">1183-swap-out-jemalloc</a></li><li><a href="1184-stabilize-no_std.html">1184-stabilize-no_std</a></li><li><a href="1191-hir.html">1191-hir</a></li><li><a href="1192-inclusive-ranges.html">1192-inclusive-ranges</a></li><li><a href="1193-cap-lints.html">1193-cap-lints</a></li><li><a href="1194-set-recovery.html">1194-set-recovery</a></li><li><a href="1199-simd-infrastructure.html">1199-simd-infrastructure</a></li><li><a href="1200-cargo-install.html">1200-cargo-install</a></li><li><a href="1201-naked-fns.html">1201-naked-fns</a></li><li><a href="1210-impl-specialization.html">1210-impl-specialization</a></li><li><a href="1211-mir.html">1211-mir</a></li><li><a href="1212-line-endings.html">1212-line-endings</a></li><li><a href="1214-projections-lifetimes-and-wf.html">1214-projections-lifetimes-and-wf</a></li><li><a href="1216-bang-type.html">1216-bang-type</a></li><li><a href="1219-use-group-as.html">1219-use-group-as</a></li><li><a href="1228-placement-left-arrow.html">1228-placement-left-arrow</a></li><li><a href="1229-compile-time-asserts.html">1229-compile-time-asserts</a></li><li><a href="1236-stabilize-catch-panic.html">1236-stabilize-catch-panic</a></li><li><a href="1238-nonparametric-dropck.html">1238-nonparametric-dropck</a></li><li><a href="1240-repr-packed-unsafe-ref.html">1240-repr-packed-unsafe-ref</a></li><li><a href="1241-no-wildcard-deps.html">1241-no-wildcard-deps</a></li><li><a href="1242-rust-lang-crates.html">1242-rust-lang-crates</a></li><li><a href="1252-open-options.html">1252-open-options</a></li><li><a href="1257-drain-range-2.html">1257-drain-range-2</a></li><li><a href="1260-main-reexport.html">1260-main-reexport</a></li><li><a href="1268-allow-overlapping-impls-on-marker-traits.html">1268-allow-overlapping-impls-on-marker-traits</a></li><li><a href="1270-deprecation.html">1270-deprecation</a></li><li><a href="1288-time-improvements.html">1288-time-improvements</a></li><li><a href="1291-promote-libc.html">1291-promote-libc</a></li><li><a href="1298-incremental-compilation.html">1298-incremental-compilation</a></li><li><a href="1300-intrinsic-semantics.html">1300-intrinsic-semantics</a></li><li><a href="1307-osstring-methods.html">1307-osstring-methods</a></li><li><a href="1317-ide.html">1317-ide</a></li><li><a href="1327-dropck-param-eyepatch.html">1327-dropck-param-eyepatch</a></li><li><a href="1328-global-panic-handler.html">1328-global-panic-handler</a></li><li><a href="1331-grammar-is-canonical.html">1331-grammar-is-canonical</a></li><li><a href="1358-repr-align.html">1358-repr-align</a></li><li><a href="1359-process-ext-unix.html">1359-process-ext-unix</a></li><li><a href="1361-cargo-cfg-dependencies.html">1361-cargo-cfg-dependencies</a></li><li><a href="1398-kinds-of-allocators.html">1398-kinds-of-allocators</a></li><li><a href="1399-repr-pack.html">1399-repr-pack</a></li><li><a href="1414-rvalue_static_promotion.html">1414-rvalue_static_promotion</a></li><li><a href="1415-trim-std-os.html">1415-trim-std-os</a></li><li><a href="1419-slice-copy.html">1419-slice-copy</a></li><li><a href="1422-pub-restricted.html">1422-pub-restricted</a></li><li><a href="1432-replace-slice.html">1432-replace-slice</a></li><li><a href="1434-contains-method-for-ranges.html">1434-contains-method-for-ranges</a></li><li><a href="1440-drop-types-in-const.html">1440-drop-types-in-const</a></li><li><a href="1443-extended-compare-and-swap.html">1443-extended-compare-and-swap</a></li><li><a href="1444-union.html">1444-union</a></li><li><a href="1445-restrict-constants-in-patterns.html">1445-restrict-constants-in-patterns</a></li><li><a href="1461-net2-mutators.html">1461-net2-mutators</a></li><li><a href="1467-volatile.html">1467-volatile</a></li><li><a href="1479-unix-socket.html">1479-unix-socket</a></li><li><a href="1492-dotdot-in-patterns.html">1492-dotdot-in-patterns</a></li><li><a href="1498-ipv6addr-octets.html">1498-ipv6addr-octets</a></li><li><a href="1504-int128.html">1504-int128</a></li><li><a href="1506-adt-kinds.html">1506-adt-kinds</a></li><li><a href="1510-cdylib.html">1510-cdylib</a></li><li><a href="1513-less-unwinding.html">1513-less-unwinding</a></li><li><a href="1521-copy-clone-semantics.html">1521-copy-clone-semantics</a></li><li><a href="1522-conservative-impl-trait.html">1522-conservative-impl-trait</a></li><li><a href="1525-cargo-workspace.html">1525-cargo-workspace</a></li><li><a href="1535-stable-overflow-checks.html">1535-stable-overflow-checks</a></li><li><a href="1542-try-from.html">1542-try-from</a></li><li><a href="1543-integer_atomics.html">1543-integer_atomics</a></li><li><a href="1548-global-asm.html">1548-global-asm</a></li><li><a href="1552-contains-method-for-various-collections.html">1552-contains-method-for-various-collections</a></li><li><a href="1558-closure-to-fn-coercion.html">1558-closure-to-fn-coercion</a></li><li><a href="1559-attributes-with-literals.html">1559-attributes-with-literals</a></li><li><a href="1560-name-resolution.html">1560-name-resolution</a></li><li><a href="1561-macro-naming.html">1561-macro-naming</a></li><li><a href="1566-proc-macros.html">1566-proc-macros</a></li><li><a href="1567-long-error-codes-explanation-normalization.html">1567-long-error-codes-explanation-normalization</a></li><li><a href="1574-more-api-documentation-conventions.html">1574-more-api-documentation-conventions</a></li><li><a href="1576-macros-literal-matcher.html">1576-macros-literal-matcher</a></li><li><a href="1581-fused-iterator.html">1581-fused-iterator</a></li><li><a href="1584-macros.html">1584-macros</a></li><li><a href="1589-rustc-bug-fix-procedure.html">1589-rustc-bug-fix-procedure</a></li><li><a href="1590-macro-lifetimes.html">1590-macro-lifetimes</a></li><li><a href="1598-generic_associated_types.html">1598-generic_associated_types</a></li><li><a href="1607-style-rfcs.html">1607-style-rfcs</a></li><li><a href="1618-ergonomic-format-args.html">1618-ergonomic-format-args</a></li><li><a href="1620-regex-1.0.html">1620-regex-1.0</a></li><li><a href="1623-static.html">1623-static</a></li><li><a href="1624-loop-break-value.html">1624-loop-break-value</a></li><li><a href="1636-document_all_features.html">1636-document_all_features</a></li><li><a href="1640-duration-checked-sub.html">1640-duration-checked-sub</a></li><li><a href="1643-memory-model-strike-team.html">1643-memory-model-strike-team</a></li><li><a href="1644-default-and-expanded-rustc-errors.html">1644-default-and-expanded-rustc-errors</a></li><li><a href="1647-allow-self-in-where-clauses.html">1647-allow-self-in-where-clauses</a></li><li><a href="1649-atomic-access.html">1649-atomic-access</a></li><li><a href="1651-movecell.html">1651-movecell</a></li><li><a href="1653-assert_ne.html">1653-assert_ne</a></li><li><a href="1660-try-borrow.html">1660-try-borrow</a></li><li><a href="1665-windows-subsystem.html">1665-windows-subsystem</a></li><li><a href="1679-panic-safe-slicing.html">1679-panic-safe-slicing</a></li><li><a href="1681-macros-1.1.html">1681-macros-1.1</a></li><li><a href="1682-field-init-shorthand.html">1682-field-init-shorthand</a></li><li><a href="1683-docs-team.html">1683-docs-team</a></li><li><a href="1685-deprecate-anonymous-parameters.html">1685-deprecate-anonymous-parameters</a></li><li><a href="1695-add-error-macro.html">1695-add-error-macro</a></li><li><a href="1696-discriminant.html">1696-discriminant</a></li><li><a href="1717-dllimport.html">1717-dllimport</a></li><li><a href="1721-crt-static.html">1721-crt-static</a></li><li><a href="1725-unaligned-access.html">1725-unaligned-access</a></li><li><a href="1728-north-star.html">1728-north-star</a></li><li><a href="1733-trait-alias.html">1733-trait-alias</a></li><li><a href="1758-repr-transparent.html">1758-repr-transparent</a></li><li><a href="1774-roadmap-2017.html">1774-roadmap-2017</a></li><li><a href="1789-as-cell.html">1789-as-cell</a></li><li><a href="1824-crates.io-default-ranking.html">1824-crates.io-default-ranking</a></li><li><a href="1826-change-doc-default-urls.html">1826-change-doc-default-urls</a></li><li><a href="1828-rust-bookshelf.html">1828-rust-bookshelf</a></li><li><a href="1845-shared-from-slice.html">1845-shared-from-slice</a></li><li><a href="1849-non-static-type-id.html">1849-non-static-type-id</a></li><li><a href="1857-stabilize-drop-order.html">1857-stabilize-drop-order</a></li><li><a href="1859-try-trait.html">1859-try-trait</a></li><li><a href="1860-manually-drop.html">1860-manually-drop</a></li><li><a href="1861-extern-types.html">1861-extern-types</a></li><li><a href="1866-more-readable-assert-eq.html">1866-more-readable-assert-eq</a></li><li><a href="1868-portability-lint.html">1868-portability-lint</a></li><li><a href="1869-eprintln.html">1869-eprintln</a></li><li><a href="1884-unstable-sort.html">1884-unstable-sort</a></li><li><a href="1892-uninitialized-uninhabited.html">1892-uninitialized-uninhabited</a></li><li><a href="1909-unsized-rvalues.html">1909-unsized-rvalues</a></li><li><a href="1925-optional-match-vert.html">1925-optional-match-vert</a></li><li><a href="1937-ques-in-main.html">1937-ques-in-main</a></li><li><a href="1940-must-use-functions.html">1940-must-use-functions</a></li><li><a href="1946-intra-rustdoc-links.html">1946-intra-rustdoc-links</a></li><li><a href="1951-expand-impl-trait.html">1951-expand-impl-trait</a></li><li><a href="1961-clamp.html">1961-clamp</a></li><li><a href="1966-unsafe-pointer-reform.html">1966-unsafe-pointer-reform</a></li><li><a href="1969-cargo-prepublish.html">1969-cargo-prepublish</a></li><li><a href="1974-global-allocators.html">1974-global-allocators</a></li><li><a href="1977-public-private-dependencies.html">1977-public-private-dependencies</a></li><li><a href="1983-nursery-deprecation.html">1983-nursery-deprecation</a></li><li><a href="1985-tiered-browser-support.html">1985-tiered-browser-support</a></li><li><a href="1990-external-doc-attribute.html">1990-external-doc-attribute</a></li><li><a href="2000-const-generics.html">2000-const-generics</a></li><li><a href="2005-match-ergonomics.html">2005-match-ergonomics</a></li><li><a href="2008-non-exhaustive.html">2008-non-exhaustive</a></li><li><a href="2011-generic-assert.html">2011-generic-assert</a></li><li><a href="2025-nested-method-calls.html">2025-nested-method-calls</a></li><li><a href="2027-object_safe_for_dispatch.html">2027-object_safe_for_dispatch</a></li><li><a href="2033-experimental-coroutines.html">2033-experimental-coroutines</a></li><li><a href="2043-is-aligned-intrinsic.html">2043-is-aligned-intrinsic</a></li><li><a href="2044-license-rfcs.html">2044-license-rfcs</a></li><li><a href="2045-target-feature.html">2045-target-feature</a></li><li><a href="2046-label-break-value.html">2046-label-break-value</a></li><li><a href="2052-epochs.html">2052-epochs</a></li><li><a href="2056-allow-trivial-where-clause-constraints.html">2056-allow-trivial-where-clause-constraints</a></li><li><a href="2057-refcell-replace.html">2057-refcell-replace</a></li><li><a href="2070-panic-implementation.html">2070-panic-implementation</a></li><li><a href="2071-impl-trait-existential-types.html">2071-impl-trait-existential-types</a></li><li><a href="2071-impl-trait-type-alias.html">2071-impl-trait-type-alias</a></li><li><a href="2086-allow-if-let-irrefutables.html">2086-allow-if-let-irrefutables</a></li><li><a href="2089-implied-bounds.html">2089-implied-bounds</a></li><li><a href="2091-inline-semantic.html">2091-inline-semantic</a></li><li><a href="2093-infer-outlives.html">2093-infer-outlives</a></li><li><a href="2094-nll.html">2094-nll</a></li><li><a href="2102-unnamed-fields.html">2102-unnamed-fields</a></li><li><a href="2103-tool-attributes.html">2103-tool-attributes</a></li><li><a href="2113-dyn-trait-syntax.html">2113-dyn-trait-syntax</a></li><li><a href="2115-argument-lifetimes.html">2115-argument-lifetimes</a></li><li><a href="2116-alloc-me-maybe.html">2116-alloc-me-maybe</a></li><li><a href="2124-option-filter.html">2124-option-filter</a></li><li><a href="2126-path-clarity.html">2126-path-clarity</a></li><li><a href="2128-use-nested-groups.html">2128-use-nested-groups</a></li><li><a href="2132-copy-closures.html">2132-copy-closures</a></li><li><a href="2133-all-the-clones.html">2133-all-the-clones</a></li><li><a href="2136-build-systems.html">2136-build-systems</a></li><li><a href="2137-variadic.html">2137-variadic</a></li><li><a href="2141-alternative-registries.html">2141-alternative-registries</a></li><li><a href="2145-type-privacy.html">2145-type-privacy</a></li><li><a href="2151-raw-identifiers.html">2151-raw-identifiers</a></li><li><a href="2166-impl-only-use.html">2166-impl-only-use</a></li><li><a href="2169-euclidean-modulo.html">2169-euclidean-modulo</a></li><li><a href="2175-if-while-or-patterns.html">2175-if-while-or-patterns</a></li><li><a href="2195-really-tagged-unions.html">2195-really-tagged-unions</a></li><li><a href="2196-metabuild.html">2196-metabuild</a></li><li><a href="2203-const-repeat-expr.html">2203-const-repeat-expr</a></li><li><a href="2226-fmt-debug-hex.html">2226-fmt-debug-hex</a></li><li><a href="2229-capture-disjoint-fields.html">2229-capture-disjoint-fields</a></li><li><a href="2230-bury-description.html">2230-bury-description</a></li><li><a href="2235-libc-struct-traits.html">2235-libc-struct-traits</a></li><li><a href="2250-finalize-impl-dyn-syntax.html">2250-finalize-impl-dyn-syntax</a></li><li><a href="2282-profile-dependencies.html">2282-profile-dependencies</a></li><li><a href="2289-associated-type-bounds.html">2289-associated-type-bounds</a></li><li><a href="2294-if-let-guard.html">2294-if-let-guard</a></li><li><a href="2295-os-str-pattern.html">2295-os-str-pattern</a></li><li><a href="2296-option-replace.html">2296-option-replace</a></li><li><a href="2298-macro-at-most-once-rep.html">2298-macro-at-most-once-rep</a></li><li><a href="2300-self-in-typedefs.html">2300-self-in-typedefs</a></li><li><a href="2302-tuple-struct-self-ctor.html">2302-tuple-struct-self-ctor</a></li><li><a href="2306-convert-id.html">2306-convert-id</a></li><li><a href="2307-concrete-nonzero-types.html">2307-concrete-nonzero-types</a></li><li><a href="2314-roadmap-2018.html">2314-roadmap-2018</a></li><li><a href="2318-custom-test-frameworks.html">2318-custom-test-frameworks</a></li><li><a href="2325-stable-simd.html">2325-stable-simd</a></li><li><a href="2333-prior-art.html">2333-prior-art</a></li><li><a href="2338-type-alias-enum-variants.html">2338-type-alias-enum-variants</a></li><li><a href="2341-const-locals.html">2341-const-locals</a></li><li><a href="2342-const-control-flow.html">2342-const-control-flow</a></li><li><a href="2344-const-looping.html">2344-const-looping</a></li><li><a href="2345-const-panic.html">2345-const-panic</a></li><li><a href="2349-pin.html">2349-pin</a></li><li><a href="2351-is-sorted.html">2351-is-sorted</a></li><li><a href="2359-subslice-pattern-syntax.html">2359-subslice-pattern-syntax</a></li><li><a href="2360-bench-black-box.html">2360-bench-black-box</a></li><li><a href="2361-dbg-macro.html">2361-dbg-macro</a></li><li><a href="2363-arbitrary-enum-discriminant.html">2363-arbitrary-enum-discriminant</a></li><li><a href="2383-lint-reasons.html">2383-lint-reasons</a></li><li><a href="2386-used.html">2386-used</a></li><li><a href="2388-try-expr.html">2388-try-expr</a></li><li><a href="2394-async_await.html">2394-async_await</a></li><li><a href="2397-do-not-recommend.html">2397-do-not-recommend</a></li><li><a href="2412-optimize-attr.html">2412-optimize-attr</a></li><li><a href="2420-unreserve-proc.html">2420-unreserve-proc</a></li><li><a href="2421-unreservations-2018.html">2421-unreservations-2018</a></li><li><a href="2436-style-guide.html">2436-style-guide</a></li><li><a href="2437-rustfmt-stability.html">2437-rustfmt-stability</a></li><li><a href="2438-deny-integer-literal-overflow-lint.html">2438-deny-integer-literal-overflow-lint</a></li><li><a href="2451-re-rebalancing-coherence.html">2451-re-rebalancing-coherence</a></li><li><a href="2457-non-ascii-idents.html">2457-non-ascii-idents</a></li><li><a href="2471-lint-test-inner-function.html">2471-lint-test-inner-function</a></li><li><a href="2476-clippy-uno.html">2476-clippy-uno</a></li><li><a href="2480-liballoc.html">2480-liballoc</a></li><li><a href="2495-min-rust-version.html">2495-min-rust-version</a></li><li><a href="2497-if-let-chains.html">2497-if-let-chains</a></li><li><a href="2500-needle.html">2500-needle</a></li><li><a href="2504-fix-error.html">2504-fix-error</a></li><li><a href="2514-union-initialization-and-drop.html">2514-union-initialization-and-drop</a></li><li><a href="2515-type_alias_impl_trait.html">2515-type_alias_impl_trait</a></li><li><a href="2521-c_void-reunification.html">2521-c_void-reunification</a></li><li><a href="2523-cfg-path-version.html">2523-cfg-path-version</a></li><li><a href="2526-const-wildcard.html">2526-const-wildcard</a></li><li><a href="2532-associated-type-defaults.html">2532-associated-type-defaults</a></li><li><a href="2535-or-patterns.html">2535-or-patterns</a></li><li><a href="2539-cfg_attr-multiple-attrs.html">2539-cfg_attr-multiple-attrs</a></li><li><a href="2561-future-possibilities.html">2561-future-possibilities</a></li><li><a href="2565-formal-function-parameter-attributes.html">2565-formal-function-parameter-attributes</a></li><li><a href="2570-linked-list-cursors.html">2570-linked-list-cursors</a></li><li><a href="2574-simd-ffi.html">2574-simd-ffi</a></li><li><a href="2582-raw-reference-mir-operator.html">2582-raw-reference-mir-operator</a></li><li><a href="2591-exhaustive-integer-pattern-matching.html">2591-exhaustive-integer-pattern-matching</a></li><li><a href="2592-futures.html">2592-futures</a></li><li><a href="2603-symbol-name-mangling-v2.html">2603-symbol-name-mangling-v2</a></li><li><a href="2627-raw-dylib-kind.html">2627-raw-dylib-kind</a></li><li><a href="2645-transparent-unions.html">2645-transparent-unions</a></li><li><a href="2657-roadmap-2019.html">2657-roadmap-2019</a></li><li><a href="2678-named-custom-cargo-profiles.html">2678-named-custom-cargo-profiles</a></li><li><a href="2689-compiler-team-contributors.html">2689-compiler-team-contributors</a></li><li><a href="2696-debug-map-key-value.html">2696-debug-map-key-value</a></li><li><a href="2700-associated-constants-on-ints.html">2700-associated-constants-on-ints</a></li><li><a href="2707-dotdot-patterns.html">2707-dotdot-patterns</a></li><li><a href="2795-format-args-implicit-identifiers.html">2795-format-args-implicit-identifiers</a></li><li><a href="2797-project-ffi-unwind.html">2797-project-ffi-unwind</a></li><li><a href="2835-project-safe-transmute.html">2835-project-safe-transmute</a></li><li><a href="2837-demote-apple-32bit.html">2837-demote-apple-32bit</a></li></ol>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">The Rust RFC Book</h1> 

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <ul>
<li>Start Date: 2014-11-10</li>
<li>RFC PR: <a href="https://github.com/rust-lang/rfcs/pull/458">rust-lang/rfcs#458</a></li>
<li>Rust Issue: <a href="https://github.com/rust-lang/rust/issues/22251">rust-lang/rust#22251</a></li>
</ul>
<a class="header" href="#summary" id="summary"><h1>Summary</h1></a>
<p>I propose altering the <code>Send</code> trait as proposed by RFC #17 as
follows:</p>
<ul>
<li>Remove the implicit <code>'static</code> bound from <code>Send</code>.</li>
<li>Make <code>&amp;T</code> <code>Send</code> if and only if <code>T</code> is <code>Sync</code>.
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
impl&lt;'a, T&gt; !Send for &amp;'a T {}

unsafe impl&lt;'a, T&gt; Send for &amp;'a T where T: Sync + 'a {}
#}</code></pre></pre>
</li>
<li>Evaluate each <code>Send</code> bound currently in <code>libstd</code> and either leave it as-is, add an
explicit <code>'static</code> bound, or bound it with another lifetime parameter.</li>
</ul>
<a class="header" href="#motivation" id="motivation"><h1>Motivation</h1></a>
<p>Currently, Rust has two types that deal with concurrency: <code>Sync</code> and <code>Send</code></p>
<p>If <code>T</code> is <code>Sync</code>, then <code>&amp;T</code> is threadsafe (that is, can cross task boundaries without
data races).  This is always true of any type with simple inherited mutability, and it is also true
of types with interior mutability that perform explicit synchronization (e.g. <code>Mutex</code> and
<code>Arc</code>).  By fiat, in safe code all static items require a <code>Sync</code> bound.  <code>Sync</code> is most
interesting as the proposed bound for closures in a fork-join concurrency model, where the thread
running the closure can be guaranteed to terminate before some lifetime <code>'a</code>, and as one of the
required bounds for <code>Arc</code>.</p>
<p>If <code>T</code> is <code>Send</code>, then <code>T</code> is threadsafe to send between tasks.  At an initial glance,
this type is harder to define.  <code>Send</code> currently requires a <code>'static</code> bound, which excludes
types with non-'static references, and there are a few types (notably, <code>Rc</code> and
<code>local_data::Ref</code>) that opt out of <code>Send</code>.  All static items other than those that are
<code>Sync</code> but not <code>Send</code> (in the stdlib this is just <code>local_data::Ref</code> and its derivatives)
are <code>Send</code>.  <code>Send</code> is most interesting as a required bound for <code>Mutex</code>, channels, <code>spawn()</code>, and
other concurrent types and functions.</p>
<p>This RFC is mostly motivated by the challenges of writing a safe interface for fork-join concurrency
in current Rust.  Specifically:</p>
<ul>
<li>It is not clear what it means for a type to be <code>Sync</code> but not <code>Send</code>.  Currently there
is nothing in the type system preventing these types from being instantiated.  In a fork-join
model with a bounded, non-<code>'static</code> lifetime <code>'a</code> for worker tasks, using a
<code>Sync + 'a</code> bound on a closure is the intended way to make sure the operation is safe to run
in another thread in parallel with the main thread.  But there is no way of preventing the main
and worker tasks from concurrently accessing an item that is <code>Sync + NoSend</code>.</li>
<li>Because <code>Send</code> has a <code>'static</code> bound, most concurrency constructs cannot be used if they have any non-static references in them, even in a thread with a bounded lifetime.  It seems like there should be a way to extend <code>Send</code> to shorter lifetimes.  But
naively removing the <code>'static</code> bound causes memory unsafety in existing APIs like Mutex.</li>
</ul>
<a class="header" href="#detailed-design" id="detailed-design"><h1>Detailed Design</h1></a>
<a class="header" href="#proposal" id="proposal"><h2>Proposal</h2></a>
<p>Extend the current meaning of <code>Send</code> in a (mostly) backwards-compatible way that
retains memory-safety, but allows for existing concurrent types like <code>Arc</code> and <code>Mutex</code> to be
used across non-<code>'static</code> boundaries.  Use <code>Send</code> with a bounded lifetime instead of <code>Sync</code> for fork-join concurrency.</p>
<p>The first proposed change is to remove the <code>'static</code> bound from <code>Send</code>.  Without doing this,
we would have to write brand new types for fork-join libraries that took <code>Sync</code> bounds but were
otherwise identical to the existing implementations.  For example, we cannot create a
<code>Mutex&lt;Vec&lt;&amp;'a mut uint&gt;&gt;</code> as long as <code>Mutex</code> requires a <code>'static</code> bound.  By itself,
though, this causes unsafety.  For example, a <code>Mutex&lt;&amp;'a Cell&lt;bool&gt;&gt;</code> does not necessarily
actually lock the data in the <code>Cell</code>:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
let cell = Cell:new(true);
let ref_ = &amp;cell;
let mutex = Mutex::new(&amp;cell);
ref_.set(false); // Modifying the cell without locking the Mutex.
#}</code></pre></pre>
<p>This leads us to our second refinement.  We add the rule that <code>&amp;T</code> is <code>Send</code> if and only if
<code>T</code> is <code>Sync</code>--in other words, we disallow <code>Send</code>ing shared references with a
non-threadsafe interior.  We do, however, still allow <code>&amp;mut T</code> where <code>T</code> is <code>Send</code>, even
if it is not <code>Sync</code>.  This is safe because <code>&amp;mut T</code> linearizes access--the only way to
access the the original data is through the unique reference, so it is safe to send to other
threads.  Similarly, we allow <code>&amp;T</code> where <code>T</code> is <code>Sync</code>, even if it is not <code>Send</code>, since by the definition of <code>Sync</code> <code>&amp;T</code> is already known to be threadsafe.</p>
<p>Note that this definition of <code>Send</code> is identical to the old definition of <code>Send</code> when
restricted to <code>'static</code> lifetimes in safe code.  Since <code>static mut</code> items are not accessible
in safe code, and it is not possible to create a safe <code>&amp;'static mut</code> outside of such an item, we
know that if <code>T: Send + 'static</code>, it either has only <code>&amp;'static</code> references, or has no references at
all.  Since <code>'static</code> references can only be created in <code>static</code> items and literals in safe code, and
all <code>static</code> items (and literals) are <code>Sync</code>, we know that any such references are <code>Sync</code>.  Thus, our
new rule that <code>T</code> must be <code>Sync</code> for <code>&amp;'static T</code> to be <code>Send</code> does not actually
remove <code>Send</code> from any existing types.  And since <code>T</code> has no <code>&amp;'static mut</code> references,
unless any were created in unsafe code, we also know that our rule allowing <code>&amp;'static mut T</code>
did not add <code>Send</code> to any new types.  We conclude that the second refinement is backwards compatible
with the old behavior, provided that old interfaces are updated to require <code>'static</code> bounds and they did not
create unsafe <code>'static</code> and <code>'static mut</code> references.  But unsafe types like these were already not
guaranteed to be threadsafe by Rust's type system.</p>
<p>Another important note is that with this definition, <code>Send</code> will fulfill the proposed role of <code>Sync</code> in a fork-join concurrency library.  At present, to use <code>Sync</code> in a fork-join library one must make the implicit assumption that if <code>T</code> is <code>Sync</code>, <code>T</code> is <code>Send</code>.  One might be tempted to codify this by making <code>Sync</code> a subtype of <code>Send</code>.  Unfortunately, this is not always the case, though it should be most of the time.  A type can be created with <code>&amp;mut</code> methods that are not thread safe, but no <code>&amp;</code>-methods that are not thread safe.  An example would be a version of <code>Rc</code> called <code>RcMut</code>.  <code>RcMut</code> would have a <code>clone_mut()</code> method that took <code>&amp;mut self</code> and no other <code>clone()</code> method.  <code>RcMut</code> could be thread-safely shared provided that a <code>&amp;mut RcMut</code> was not sent to another thread.  As long as that invariant was upheld, <code>RcMut</code> could only be cloned in its original thread and could not be dropped while shared (hence, <code>RcMut</code> is <code>Sync</code>) but a mutable reference could not be thread-safely shared, nor could it be moved into another thread (hence, <code>&amp;mut RcMut</code> is not <code>Send</code>, which means that <code>RcMut</code> is not <code>Send</code>).  Because <code>&amp;T</code> is Send if <code>T</code> is Sync (per the new definition), adding a <code>Send</code> bound will guarantee that only shared pointers of this type are moved between threads, so our new definition of <code>Send</code> preserves thread safety in the presence of such types.</p>
<p>Finally, we'd hunt through existing instances of <code>Send</code> in Rust libraries and replace them with
sensible defaults.  For example, the <code>spawn()</code> APIs should all have <code>'static</code> bounds,
preserving current behavior.  I don't think this would be too difficult, but it may be that there
are some edge cases here where it's tricky to determine what the right solution is.</p>
<a class="header" href="#more-unusual-types" id="more-unusual-types"><h2>More unusual types</h2></a>
<p>We discussed whether a type with a destructor that manipulated thread-local data could be non-<code>Send</code> even though <code>&amp;mut T</code> was.  In general it could not, because you can call a destructor through <code>&amp;mut</code> references (through <code>swap</code> or simply assigning a new value to <code>*x</code> where <code>x: &amp;mut T</code>).  It was noted that since <code>&amp;uniq T</code> cannot be dropped, this suggests a role for such types.</p>
<p>Some unusual types proposed by <code>arielb1</code> and myself to explain why <code>T: Send</code> does not mean <code>&amp;mut T</code> is threadsafe, and <code>T: Sync</code> does not imply <code>T: Send</code>.  The first type is a bottom type, the second takes <code>self</code> by value (so <code>RcMainTask</code> is not <code>Send</code> but <code>&amp;mut RcMainTask</code> is <code>Send</code>).</p>
<p>Comments from arielb1:</p>
<p>Observe that <code>RcMainTask::main_clone</code> would be unsafe outside the main task.</p>
<p><code>&amp;mut Xyz</code> and <code>&amp;mut RcMainTask</code> are perfectly fine <code>Send</code> types. However, <code>Xyz</code> is a bottom (can be used to violate memory safety), and <code>RcMainTask</code> is not <code>Send</code>.</p>
<pre><pre class="playpen"><code class="language-rust">#![feature(tuple_indexing)]
use std::rc::Rc;
use std::mem;
use std::kinds::marker;

// Invariant: &amp;mut Xyz always points to a valid C xyz.
// Xyz rvalues don't exist.

// These leak. I *could* wrap a box or arena, but that would
// complicate things.

extern &quot;C&quot; {
    // struct Xyz;
    fn xyz_create() -&gt; *mut Xyz;
    fn xyz_play(s: *mut Xyz);
}

pub struct Xyz(marker::NoCopy);

impl Xyz {
    pub fn new() -&gt; &amp;'static mut Xyz {
        unsafe {
            let x = xyz_create();
            mem::transmute(x)
        }
    }

    pub fn play(&amp;mut self) {
        unsafe { xyz_play(mem::transmute(self)) }
    }
}

// Invariant: only the main task has RcMainTask values

pub struct RcMainTask&lt;T&gt;(Rc&lt;T&gt;);
impl&lt;T&gt; RcMainTask&lt;T&gt; {
    pub fn new(t: T) -&gt; Option&lt;RcMainTask&lt;T&gt;&gt; {
        if on_main_task() {
            Some(RcMainTask(Rc::new(t)))
        } else { None }
    }

    pub fn main_clone(self) -&gt; (RcMainTask&lt;T&gt;, RcMainTask&lt;T&gt;) {
        let new = RcMainTask(self.0.clone());
        (self, new)
    }
}

impl&lt;T&gt; Deref&lt;T&gt; for RcMainTask&lt;T&gt; {
    fn deref(&amp;self) -&gt; &amp;T { &amp;*self.0 }
}

//  - by Sharp

pub struct RcMut&lt;T&gt;(Rc&lt;T&gt;);
impl&lt;T&gt; RcMut&lt;T&gt; {
    pub fn new(t: T) -&gt; RcMut&lt;T&gt; {
        RcMut(Rc::new(t))
    }

    pub fn mut_clone(&amp;mut self) -&gt; RcMut&lt;T&gt; {
        RcMut(self.0.clone())
    }
}

impl&lt;T&gt; Deref&lt;T&gt; for RcMut&lt;T&gt; {
    fn deref(&amp;self) -&gt; &amp;T { &amp;*self.0 }
}

// fn on_main_task() -&gt; bool { false /* XXX: implement */ }
// fn main() {}
</code></pre></pre>
<a class="header" href="#drawbacks" id="drawbacks"><h1>Drawbacks</h1></a>
<p>Libraries get a bit more complicated to write, since you may have to write <code>Send + 'static</code> where previously you just wrote <code>Send</code>.</p>
<a class="header" href="#alternatives" id="alternatives"><h1>Alternatives</h1></a>
<p>We could accept the status quo.  This would mean that any existing <code>Sync</code> <code>NoSend</code>
type like those described above would be unsafe (that is, it would not be possible to write a non-<code>'static</code> closure with the correct bounds to make it safe to use), and it would not be possible to write a type like <code>Arc&lt;T&gt;</code> for a <code>T</code> with a bounded lifetime, as well as other safe concurrency constructs for fork-join concurrency.  I do not think this is a good alternative.</p>
<p>We could do as proposed above, but change <code>Sync</code> to be a subtype of <code>Send</code>.  Things wouldn't be too
different, but you wouldn't be able to write types like those discussed above.  I am not sure that types like that are actually useful, but even if we did this I think you would usually want to use a <code>Send</code> bound anyway.</p>
<p>We could do as proposed above, but instead of changing <code>Send</code>, create a new type for this
purpose.  I suppose the advantage of this would be that user code currently using <code>Send</code> as a way to
get a <code>'static</code> bound would not break.  However, I don't think it makes a lot of sense to keep the
current <code>Send</code> type around if this is implemented, since the new type should be backwards compatible
with it where it was being used semantically correctly.</p>
<a class="header" href="#unresolved-questions" id="unresolved-questions"><h1>Unresolved questions</h1></a>
<ul>
<li>
<p>Is the new scheme actually safe?  I <em>think</em> it is, but I certainly haven't proved it.</p>
</li>
<li>
<p>Can this wait until after Rust 1.0, if implemented?  I think it is backwards incompatible, but I
believe it will also be much easier to implement once opt-in kinds are fully implemented.</p>
</li>
<li>
<p>Is this actually necessary?  I've asserted that I think it's important to be able to do the same
things in bounded-lifetime threads that you can in regular threads, but it may be that it isn't.</p>
</li>
<li>
<p>Are types that are <code>Sync</code> and <code>NoSend</code> actually useful?</p>
</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="0453-macro-reform.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="0459-disallow-shadowing.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="0453-macro-reform.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="0459-disallow-shadowing.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
